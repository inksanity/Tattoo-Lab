<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Tattoo Lab ‚Äî Color (Stencil Removed)</title>
<link rel="manifest" href="manifest.json">
<style>
  :root{
    --bg:#0f1115; --text:#e6e8ec; --muted:#b6bac4;
    --panel: linear-gradient(180deg,#1a1f29 0%, #0f141b 100%);
    --shadow: 0 8px 18px rgba(0,0,0,.45);
    --radius:14px;
    --font: ui-sans-serif,-apple-system,system-ui,Segoe UI,Inter,Roboto,Arial;
    --grid-size: 40px; /* adjustable */
    --grid-color: rgba(255,255,255,.10);
  }
  body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:var(--font);font-size:14px}
  .metal{background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid rgba(255,255,255,.06)}

  /* Top bar */
  .topbar{display:flex;align-items:center;justify-content:space-between;padding:6px 10px;gap:10px;background:linear-gradient(180deg,#161a22,#0e1218);height:56px}
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:32px;height:32px;border-radius:8px;}
  .chip{border-radius:999px;padding:4px 8px;color:var(--muted);background:#1c2330;font-size:12px;border:1px solid rgba(255,255,255,.08)}
  .top-tools{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end;max-width:70vw}
  .tool-btn{border:1px solid rgba(255,255,255,.1);background:#243044;color:var(--text);border-radius:8px;padding:4px 8px;cursor:pointer;font-size:12px;white-space:nowrap; transition: background 0.2s ease;}
  .tool-btn:hover{background:#30405c;}
  .tool-btn.small{padding:3px 8px}

  .workspace{position:relative;height:calc(100% - 56px); display:flex; justify-content:center; align-items:center; padding: 10px;}
  #canvas-container{position:relative;border-radius:14px;background:#0b0d11;box-shadow:var(--shadow);border:1px solid rgba(255,255,255,.06);overflow:hidden; width: 100%; max-width: 1600px; height: 100%; max-height: 900px;}
  #mainCanvas{width:100%;height:100%;display:block;background:#0b0d11;cursor:default}
  
  /* Grid overlay */
  #gridOverlay{
    position:absolute; 
    pointer-events:none; 
    display:none;
    background-image:
      linear-gradient(0deg, red 1px, transparent 1px),
      linear-gradient(90deg, red 1px, transparent 1px);
    background-size: var(--grid-size) var(--grid-size), var(--grid-size) var(--grid-size);
  }

  /* Panels */
  #panel-layer{position:absolute; inset:0; pointer-events:none}
  .panel{position:absolute;min-width:240px;max-width:360px;pointer-events:auto;user-select:none;z-index:20;}
  .panel-header{display:flex;align-items:center;justify-content:space-between;padding:6px 8px;background:#202735;color:#c9d6ff;font-size:11px;text-transform:uppercase;border-top-left-radius:var(--radius);border-top-right-radius:var(--radius); cursor:grab;}
  .panel-header:active {cursor:grabbing;}
  .panel-inner{padding:10px;display:flex;flex-direction:column;gap:10px}
  .icon-btn{border:none;background:#243044;color:var(--text);border-radius:8px;padding:4px 8px;cursor:pointer; transition: background 0.2s ease;}
  .icon-btn:hover{background:#30405c;}
  .row{display:flex;align-items:center;gap:10px}
  .label{font-size:12px;color:var(--muted)}
  .btn{min-height:38px;padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.1);background:#2a3750;color:var(--text);font-weight:600;cursor:pointer; transition: background 0.2s ease;}
  .btn:hover{background:#384a6b;}
  .btn.primary{background:#dd4b25;}
  .btn.primary:hover{background:#c74422;}
  .select,select,input[type='text'],input[type='number'], textarea{width:100%;min-height:38px;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#22293a;color:var(--text); appearance: none; -webkit-appearance: none;}
  textarea { min-height: 80px; }
  .slider{-webkit-appearance:none;appearance:none;width:100%;height:8px;background:#2b3446;border-radius:999px;border:1px solid rgba(255,255,255,.1)}
  .slider::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:#f97316;border:1px solid rgba(255,255,255,.4); cursor:grab;}
  .slider::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:#f97316;border:1px solid rgba(255,255,255,.4); cursor:grab;}

  .swatches{display:grid;grid-template-columns:repeat(auto-fill, minmax(100px, 1fr));gap:8px}
  .swatch{display:flex;align-items:center;gap:8px;padding:8px;background:#1b2231;border:1px solid rgba(255,255,255,.08);border-radius:10px; cursor:pointer; transition: background 0.2s ease;}
  .swatch:hover{background:#2a3750;}
  .dot{width:18px;height:18px;border-radius:6px;box-shadow:inset 0 1px 0 rgba(255,255,255,.35), inset 0 -1px 0 rgba(0,0,0,.6); flex-shrink: 0;}
  .swatch .name{
    font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex-grow: 1; min-width: 0;
  }
  .swatch .remove-btn { margin-left:auto; flex-shrink:0; background:none; border:none; color:var(--muted); font-size:16px; cursor:pointer; padding:0 4px; line-height:1; }
  .swatch .remove-btn:hover {color: var(--text);}
  .color-library-grid { grid-template-columns: repeat(auto-fill, minmax(32px, 1fr)); }
  .color-library-grid .swatch { padding:4px; justify-content:center; }

  /* Draggable Loupe */
  #draggable-loupe { position:absolute; width:100px; height:100px; border-radius:50%; border:2px solid #fff; box-shadow:0 0 15px rgba(0,0,0,.5); background:#111; overflow:hidden; z-index:1000; display:none; image-rendering:pixelated; cursor:grab; pointer-events:auto; transform:translate(-50%,-50%);}
  #draggable-loupe:active {cursor:grabbing;}
  #draggable-loupe-canvas { width:100%; height:100%;}
  #draggable-loupe::after{content:'+'; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:rgba(255,255,255,0.7); font-size:20px; font-weight:bold; text-shadow:0 0 2px #000; pointer-events:none;}

  /* Loading indicator for extract */
  .loading-overlay { position:absolute; inset:0; background:rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; color:#fff; font-size:24px; border-radius:var(--radius); pointer-events:all; z-index:100; }

  /* Responsive */
  @media (max-width:1100px){ .top-tools{max-width:65vw} }
  @media (max-width:768px){
    .topbar {flex-wrap: wrap; height: auto; justify-content: center;}
    .top-tools {max-width: 100%; order: 3; justify-content: center;}
    .brand {width: 100%; justify-content: center;}
    .chip {order: 2; margin-top: 5px;}
    .workspace {padding: 5px; height: calc(100% - 56px - 30px);}
    #canvas-container {margin: 0;}
    .panel {min-width: unset; max-width: 95vw; left: 2.5vw !important; top: 70px !important;}
    .swatches {grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));}
  }
  @media (max-width:480px){
    .topbar {padding: 6px 5px;}
    .top-tools {gap: 4px;}
    .tool-btn, .tool-btn.small {font-size: 11px; padding: 3px 6px;}
    .chip {font-size: 11px;}
    .panel {top: 60px !important;}
  }
</style>
</head>
<body>
<div id="app" data-mode="color">
  <div class="topbar metal">
    <div class="brand">
      <div class="logo">TL</div>
      <div>
        <div style="font-weight:700">Tattoo Lab</div>
        <div style="font-size:11px;color:var(--muted)">Version 1.0</div>
      </div>
    </div>

    <!-- UNIVERSAL TOOLS: always visible -->
    <div class="top-tools" id="topTools">
      <button class="tool-btn small" data-tool="import">üì• Import</button>
      <button class="tool-btn small" data-tool="details">üìù Details</button>
      <button class="tool-btn small" data-tool="brightness">‚òÄÔ∏è Bright</button>
      <button class="tool-btn small" data-tool="saturation">üéöÔ∏è Sat</button>
      <button class="tool-btn small" data-tool="palette">üé® Palette</button>
      <button class="tool-btn small" data-tool="brand">üè∑Ô∏è Brand</button>
      <button class="tool-btn small" data-tool="recipes">üß™ Recipes</button>
      
      <button class="tool-btn small" data-tool="grid">#Ô∏è‚É£ Grid</button>
      <button class="tool-btn small" data-tool="library">üìö Library</button>
      <button class="tool-btn small" data-tool="export">‚¨áÔ∏è Export</button>
    </div>

    <div class="chip">Mode: <span id="modeLabel">Color</span></div>
  </div>

  <div class="workspace">
    <div id="canvas-container" class="metal">
      <canvas id="mainCanvas" width="1600" height="900"></canvas>
      <div id="gridOverlay"></div>
      <div id="panel-layer">
        <div id="draggable-loupe"><canvas id="draggable-loupe-canvas" width="100" height="100"></canvas></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== Helpers ===== */
const $=(s,c=document)=>c.querySelector(s); const $$=(s,c=document)=>Array.from(c.querySelectorAll(s));
const layer=$('#panel-layer'); let z=20;
const canvas=$('#mainCanvas'); const ctx=canvas.getContext('2d');

function rgbToXyz(r,g,b){r/=255;g/=255;b/=255; r=r<=0.04045?r/12.92:Math.pow((r+0.055)/1.055,2.4); g=g<=0.04045?g/12.92:Math.pow((g+0.055)/1.055,2.4); b=b<=0.04045?b/12.92:Math.pow((b+0.055)/1.055,2.4); return [r*0.4124+g*0.3576+b*0.1805, r*0.2126+g*0.7152+b*0.0722, r*0.0193+g*0.1192+b*0.9505]; }
function xyzToLab(x,y,z){const Xr=0.95047,Yr=1.00000,Zr=1.08883; function f(t){return t>Math.pow(6/29,3)?Math.cbrt(t):(t/(3*Math.pow(6/29,2))+4/29);} const fx=f(x/Xr),fy=f(y/Yr),fz=f(z/Zr); return [116*fy-16,500*(fx-fy),200*(fy-fz)];}
function rgbToLab(r,g,b){const xyz=rgbToXyz(r,g,b);return xyzToLab(xyz[0],xyz[1],xyz[2]);}
function deltaE2000(L1a1b1, L2a2b2){const [L1,a1,b1]=L1a1b1,[L2,a2,b2]=L2a2b2;const avgLp=(L1+L2)/2;const C1=Math.hypot(a1,b1),C2=Math.hypot(a2,b2);const avgC=(C1+C2)/2;const G=0.5*(1-Math.sqrt(Math.pow(avgC,7)/(Math.pow(avgC,7)+Math.pow(25,7))));const a1p=(1+G)*a1,a2p=(1+G)*a2;const C1p=Math.hypot(a1p,b1),C2p=Math.hypot(a2p,b2);const avgCp=(C1p+C2p)/2;const h1p=hp(a1p,b1),h2p=hp(a2p,b2);const deltahp=dh(h1p,h2p,C1p,C2p);const deltaLp=L2-L1;const deltaCp=C2p-C1p;const deltaHp=2*Math.sqrt(C1p*C2p)*Math.sin(toRad(deltahp/2));const avgHp=ahp(h1p,h2p,C1p,C2p);const T=1-0.17*Math.cos(toRad(avgHp-30))+0.24*Math.cos(toRad(2*avgHp))+0.32*Math.cos(toRad(3*avgHp+6))-0.20*Math.cos(toRad(4*avgHp-63));const Sl=1+(0.015*Math.pow(avgLp-50,2))/Math.sqrt(20+Math.pow(avgLp-50,2));const Sc=1+0.045*avgCp;const Sh=1+0.015*avgCp*T;const Rt=-2*Math.sqrt(Math.pow(avgCp,7)/(Math.pow(avgCp,7)+Math.pow(25,7)))*Math.sin(toRad(60*Math.exp(-Math.pow((avgHp-275)/25,2))));const Kl=1,Kc=1,Kh=1;return Math.sqrt(Math.pow(deltaLp/(Sl*Kl),2)+Math.pow(deltaCp/(Sc*Kc),2)+Math.pow(deltaHp/(Sh*Kh),2)+Rt*(deltaCp/(Sc*Kc))*(deltaHp/(Sh*Kh)));function toRad(d){return d*Math.PI/180}function hp(a,b){if(a===0&&b===0)return 0;const h=Math.atan2(b,a)*180/Math.PI;return h>=0?h:h+360}function dh(h1,h2,C1p,C2p){if(C1p*C2p===0)return 0;const d=h2-h1;if(Math.abs(d)<=180)return d;return d>180?d-360:d+360}function ahp(h1,h2,C1p,C2p){if(C1p*C2p===0)return h1+h2;const d=Math.abs(h1-h2);if(d<=180)return (h1+h2)/2;return (h1+h2+360)/2%360}}

function makePanel({id,title,content,x=24,y=72,width=320,onopen}){
  const existing=$('#'+id); if(existing){ existing.remove(); return null; }
  const p=document.createElement('div'); p.id=id; p.className='panel metal'; p.style.left=x+'px'; p.style.top=y+'px'; p.style.zIndex=(++z); p.style.width=width+'px';
  const h=document.createElement('div'); h.className='panel-header'; h.innerHTML=`<span>${title}</span><div style="display:flex;gap:6px"><button class='icon-btn' data-act='collapse'>‚ñ≠</button><button class='icon-btn' data-act='close'>&times;</button></div>`;
  const inner=document.createElement('div'); inner.className='panel-inner'; inner.innerHTML=content;
  p.append(h,inner); layer.append(p);
  let drag=false,ox=0,oy=0; const bounds=()=>$('#canvas-container').getBoundingClientRect();
  h.addEventListener('pointerdown',e=>{ if(e.target.closest('[data-act]')) return; drag=true; p.style.zIndex=(++z); const r=p.getBoundingClientRect(); ox=e.clientX-r.left; oy=e.clientY-r.top; h.setPointerCapture(e.pointerId)});
  h.addEventListener('pointermove',e=>{ if(!drag) return; const b=bounds(); let nx=e.clientX-ox-b.left, ny=e.clientY-oy-b.top; nx=Math.max(6,Math.min(nx,b.width-p.offsetWidth-6)); ny=Math.max(6,Math.min(ny,b.height-p.offsetHeight-6)); p.style.left=nx+'px'; p.style.top=ny+'px';});
  h.addEventListener('pointerup',()=>{ if(!drag) return; drag=false; const b=bounds(); const r=p.getBoundingClientRect(); const L=r.left-b.left,R=b.right-r.right,T=r.top-b.top,B=b.bottom-r.bottom; const m=Math.min(L,R,T,B),g=8; if(m===L) p.style.left=g+'px'; if(m===R) p.style.left=(b.width-p.offsetWidth-g)+'px'; if(m===T) p.style.top=g+'px'; if(m===B) p.style.top=(b.height-p.offsetHeight-g)+'px';});
  h.addEventListener('click',e=>{ const act=e.target.closest('[data-act]')?.dataset.act; if(act==='close') p.remove(); if(act==='collapse') inner.style.display=(inner.style.display==='none')?'flex':'none'; });
  if(typeof onopen==='function'){ onopen(p); }
  return p;
}

function alertUser(message){
  const existingModal = $('#custom-alert-modal'); if (existingModal) existingModal.remove();
  const modal = document.createElement('div');
  modal.id = 'custom-alert-modal';
  modal.style = `position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--panel); border-radius: var(--radius); box-shadow: var(--shadow); padding: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 15px; align-items: center; max-width: 300px; text-align: center;`;
  modal.innerHTML = `<div style="font-size: 16px; color: var(--text);">${message}</div><button class="btn primary" id="alert-ok-btn" style="width: 80px;">OK</button>`;
  document.body.appendChild(modal);
  $('#alert-ok-btn', modal).onclick = () => modal.remove();
}

/* ===== App State (stencil removed) ===== */
const appState = {
  img:null, imgW:0, imgH:0,
  brightness:0, saturation:0,
  brand: localStorage.getItem('tl_brand') || 'Radiant Colors',
  palette: JSON.parse(localStorage.getItem('tl_palette') || '[]'),
  dropperSize: +(localStorage.getItem('tl_dropper') || 3),
  gridSize: +(localStorage.getItem('tl_grid') || 40),
  inkCapSize: +(localStorage.getItem('tl_inkCapSize') || 20),
  gridSensitivity: +(localStorage.getItem('tl_gridSensitivity') || 10),
  projectDetails: JSON.parse(localStorage.getItem('tl_projectDetails') || '{}')
};

function saveAppState(){
  localStorage.setItem('tl_brand', appState.brand);
  localStorage.setItem('tl_palette', JSON.stringify(appState.palette));
  localStorage.setItem('tl_dropper', appState.dropperSize);
  localStorage.setItem('tl_grid', appState.gridSize);
  localStorage.setItem('tl_inkCapSize', appState.inkCapSize);
  localStorage.setItem('tl_gridSensitivity', appState.gridSensitivity);
  localStorage.setItem('tl_projectDetails', JSON.stringify(appState.projectDetails));
}

/* ===== Image loading / rendering (no stencil branch) ===== */
const off=document.createElement('canvas'); const ofx=off.getContext('2d');
(function(){ const w=canvas.width,h=canvas.height; ctx.fillStyle='#0b0d11';ctx.fillRect(0,0,w,h); ctx.fillStyle='rgba(255,255,255,.35)'; ctx.font='600 22px ui-sans-serif,system-ui,Segoe UI,Inter'; ctx.textAlign='center'; ctx.fillText('Canvas ‚Äî import an image to begin', w/2, h/2); })();
function fitContain(iw,ih,cw,ch){ const s=Math.min(cw/iw, ch/ih); return {dw:Math.round(iw*s), dh:Math.round(ih*s)}; }
async function loadImage(file){
  try{ const bmp=await createImageBitmap(file); appState.img=bmp; appState.imgW=bmp.width; appState.imgH=bmp.height; render(); }
  catch(e){ console.error(e); alertUser("Error loading image. Please try a different file."); }
}
function render(){
  const w_res=canvas.width, h_res=canvas.height;
  ctx.clearRect(0,0,w_res,h_res); ctx.fillStyle='#0b0d11'; ctx.fillRect(0,0,w_res,h_res);
  const grid=$('#gridOverlay');
  if(!appState.img){ grid.style.display='none'; return; }

  const fit = fitContain(appState.imgW, appState.imgH, w_res, h_res);
  off.width=fit.dw; off.height=fit.dh;
  ofx.clearRect(0,0,off.width,off.height);
  ofx.drawImage(appState.img,0,0,off.width,off.height);
  const imgData=ofx.getImageData(0,0,off.width,off.height); const d=imgData.data;
  const bAmt=(appState.brightness|0)*2.55; const sFac=1+(appState.saturation|0)/100;
  for(let i=0;i<d.length;i+=4){
    let r=d[i]+bAmt, g=d[i+1]+bAmt, b=d[i+2]+bAmt;
    r=r<0?0:r>255?255:r; g=g<0?0:g>255?255:g; b=b<0?0:b>255?255:b;
    const grey=0.2126*r+0.7152*g+0.0722*b;
    if(sFac!==1){ r=grey+(r-grey)*sFac; g=grey+(g-grey)*sFac; b=grey+(b-grey)*sFac; }
    d[i]=r; d[i+1]=g; d[i+2]=b;
  }
  ofx.putImageData(imgData,0,0);
  const dx=(w_res-off.width)/2, dy=(h_res-off.height)/2;
  ctx.drawImage(off,dx,dy);

  // grid overlay placement
  const w_display=canvas.clientWidth, h_display=canvas.clientHeight;
  const scale=Math.min(w_display/w_res,h_display/h_res);
  const displayed_w=off.width*scale, displayed_h=off.height*scale;
  const gx=(w_display-displayed_w)/2, gy=(h_display-displayed_h)/2;
  grid.style.left=gx+'px'; grid.style.top=gy+'px'; grid.style.width=displayed_w+'px'; grid.style.height=displayed_h+'px'; grid.style.display='block';
}
window.addEventListener('resize', render);

/* ===== DATA: Core9 + Brand base inks + RECIPES ===== */
function hexToRgb(hex){ const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16); return [r,g,b]; }
const CORE9_COLORS=[
  { name:"white", hex:"#FFFFFF" },
  { name:"yellow", hex:"#FFF44F" },
  { name:"orange", hex:"#FFA500" },
  { name:"red", hex:"#FF0000" },
  { name:"magenta", hex:"#FF00FF" },
  { name:"violet", hex:"#800080" },
  { name:"blue", hex:"#0000FF" },
  { name:"green", hex:"#008000" },
  { name:"black", hex:"#0A0A0A" }
].map(c=>({...c, lab: rgbToLab(...hexToRgb(c.hex))}));

/* ‚¨áÔ∏è PASTE YOUR ENTIRE recipesFromCSV OBJECT FROM YOUR WORKING FILE HERE (verbatim)
   (From your ‚ÄúTattoo Lab ‚Äî Prototype V1.html‚Äù)  ‚Äî keeping it identical ensures all mix math still works.
   Example header:

const recipesFromCSV = {
  "TL Color ‚Äî 30 Drops White, 1 Drop Yellow": { "label": "...", "rgb":[244,240,166], "components":[{"ink":"white","drops":30},{"ink":"yellow","drops":1}] },
  // ... the rest of your list ...
};

   Source file reference for your working block: (same structure)  [oai_citation:2‚Ä°Tattoo Lab ‚Äî Prototype V1.html](file-service://file-6yDvabmwnVp91YtyntvznV)
*/
const recipesFromCSV = {
  "30 drops of white + 1 drop of yellow": {
    "label": "30 drops of white + 1 drop of yellow",
    "rgb": [
      244,
      240,
      166
    ],
    "components": [
      {
        "ink": "white",
        "drops": 30
      },
      {
        "ink": "yellow",
        "drops": 1
      }
    ]
  },
  "Equal parts - Yellow and white": {
    "label": "Equal parts - Yellow and white",
    "rgb": [
      250,
      234,
      0
    ],
    "components": [
      {
        "ink": "white",
        "drops": 20
      },
      {
        "ink": "yellow",
        "drops": 20
      }
    ]
  },
  "20 drops of yellow + 1 drop of orange": {
    "label": "20 drops of yellow + 1 drop of orange",
    "rgb": [
      223,
      154,
      53
    ],
    "components": [
      {
        "ink": "yellow",
        "drops": 20
      },
      {
        "ink": "orange",
        "drops": 1
      }
    ]
  },
  "20 drops of yellow + 10 drops of orange": {
    "label": "20 drops of yellow + 10 drops of orange",
    "rgb": [
      229,
      123,
      53
    ],
    "components": [
      {
        "ink": "yellow",
        "drops": 20
      },
      {
        "ink": "orange",
        "drops": 10
      }
    ]
  },
  "Equal parts - Yellow and orange": {
    "label": "Equal parts - Yellow and orange",
    "rgb": [
      197,
      92,
      45
    ],
    "components": [
      {
        "ink": "yellow",
        "drops": 20
      },
      {
        "ink": "orange",
        "drops": 20
      }
    ]
  },
  "25 drops of yellow + 5 drops of red": {
    "label": "25 drops of yellow + 5 drops of red",
    "rgb": [
      167,
      86,
      59
    ],
    "components": [
      {
        "ink": "yellow",
        "drops": 25
      },
      {
        "ink": "red",
        "drops": 5
      }
    ]
  },
  "Equal parts - Yellow and red": {
    "label": "Equal parts - Yellow and red",
    "rgb": [
      135,
      42,
      45
    ],
    "components": [
      {
        "ink": "yellow",
        "drops": 20
      },
      {
        "ink": "red",
        "drops": 20
      }
    ]
  },
  "20 drops of red + 10 drops of white": {
    "label": "20 drops of red + 10 drops of white",
    "rgb": [
      133,
      41,
      54
    ],
    "components": [
      {
        "ink": "white",
        "drops": 10
      },
      {
        "ink": "red",
        "drops": 20
      }
    ]
  },
  "Equal parts - White and red": {
    "label": "Equal parts - White and red",
    "rgb": [
      187,
      74,
      86
    ],
    "components": [
      {
        "ink": "white",
        "drops": 20
      },
      {
        "ink": "red",
        "drops": 20
      }
    ]
  },
  "20 drops of white + 10 drops of red": {
    "label": "20 drops of white + 10 drops of red",
    "rgb": [
      143,
      64,
      83
    ],
    "components": [
      {
        "ink": "white",
        "drops": 20
      },
      {
        "ink": "red",
        "drops": 10
      }
    ]
  },
  "20 drops of white + 5 drops of red": {
    "label": "20 drops of white + 5 drops of red",
    "rgb": [
      166,
      85,
      110
    ],
    "components": [
      {
        "ink": "white",
        "drops": 20
      },
      {
        "ink": "red",
        "drops": 5
      }
    ]
  },
  "20 drops of white + 1 drop of red": {
    "label": "20 drops of white + 1 drop of red",
    "rgb": [
      209,
      135,
      162
    ],
    "components": [
      {
        "ink": "white",
        "drops": 20
      },
      {
        "ink": "red",
        "drops": 1
      }
    ]
  },
  "40 drops of yellow + 1 drop of blue": {
    "label": "40 drops of yellow + 1 drop of blue",
    "rgb": [
      96,
      150,
      66
    ],
    "components": [
      {
        "ink": "yellow",
        "drops": 40
      },
      {
        "ink": "blue",
        "drops": 1
      }
    ]
  },
  "40 drops of yellow + 1 drop of green": {
    "label": "40 drops of yellow + 1 drop of green",
    "rgb": [
      118,
      186,
      67
    ],
    "components": [
      {
        "ink": "yellow",
        "drops": 40
      },
      {
        "ink": "green",
        "drops": 1
      }
    ]
  },
  "25 drops of yellow + 1 drop of green": {
    "label": "25 drops of yellow + 1 drop of green",
    "rgb": [
      101,
      169,
      68
    ],
    "components": [
      {
        "ink": "yellow",
        "drops": 25
      },
      {
        "ink": "green",
        "drops": 1
      }
    ]
  },
  "20 drops of yellow + 3 drops of green": {
    "label": "20 drops of yellow + 3 drops of green",
    "rgb": [
      40,
      147,
      69
    ],
    "components": [
      {
        "ink": "yellow",
        "drops": 20
      },
      {
        "ink": "green",
        "drops": 3
      }
    ]
  },
  "20 drops of yellow + 10 drops of green": {
    "label": "20 drops of yellow + 10 drops of green",
    "rgb": [
      22,
      115,
      60
    ],
    "components": [
      {
        "ink": "yellow",
        "drops": 20
      },
      {
        "ink": "green",
        "drops": 10
      }
    ]
  },
  "Equal parts - Yellow and green": {
    "label": "Equal parts - Yellow and green",
    "rgb": [
      27,
      93,
      55
    ],
    "components": [
      {
        "ink": "yellow",
        "drops": 20
      },
      {
        "ink": "green",
        "drops": 20
      }
    ]
  },
  "20 drops of yellow + 2 drops of green + 2 drops of magenta": {
    "label": "20 drops of yellow + 2 drops of green + 2 drops of magenta",
    "rgb": [
      74,
      109,
      56
    ],
    "components": [
      {
        "ink": "yellow",
        "drops": 20
      },
      {
        "ink": "magenta",
        "drops": 2
      },
      {
        "ink": "green",
        "drops": 2
      }
    ]
  },
  "15 drops of yellow + 5 drops of white + 1 drop of magenta + 1 drop of green": {
    "label": "15 drops of yellow + 5 drops of white + 1 drop of magenta + 1 drop of green",
    "rgb": [
      118,
      145,
      60
    ],
    "components": [
      {
        "ink": "white",
        "drops": 5
      },
      {
        "ink": "yellow",
        "drops": 15
      },
      {
        "ink": "magenta",
        "drops": 1
      },
      {
        "ink": "green",
        "drops": 1
      }
    ]
  },
  "30 drops of white + 20 drops of yellow + 3 drops of magenta + 1 drop of green": {
    "label": "30 drops of white + 20 drops of yellow + 3 drops of magenta + 1 drop of green",
    "rgb": [
      97,
      102,
      60
    ],
    "components": [
      {
        "ink": "white",
        "drops": 30
      },
      {
        "ink": "yellow",
        "drops": 20
      },
      {
        "ink": "magenta",
        "drops": 3
      },
      {
        "ink": "green",
        "drops": 1
      }
    ]
  },
  "20 drops of yellow + 3 drops of magenta + 1 drop of green": {
    "label": "20 drops of yellow + 3 drops of magenta + 1 drop of green",
    "rgb": [
      70,
      74,
      41
    ],
    "components": [
      {
        "ink": "yellow",
        "drops": 20
      },
      {
        "ink": "magenta",
        "drops": 3
      },
      {
        "ink": "green",
        "drops": 1
      }
    ]
  },
  "10 drops of yellow + 10 drops of orange + 2 drops of green": {
    "label": "10 drops of yellow + 10 drops of orange + 2 drops of green",
    "rgb": [
      49,
      55,
      35
    ],
    "components": [
      {
        "ink": "yellow",
        "drops": 10
      },
      {
        "ink": "orange",
        "drops": 10
      },
      {
        "ink": "green",
        "drops": 2
      }
    ]
  },
  "30 drops of yellow + 10 drops of orange + 2 drops of green": {
    "label": "30 drops of yellow + 10 drops of orange + 2 drops of green",
    "rgb": [
      75,
      77,
      38
    ],
    "components": [
      {
        "ink": "yellow",
        "drops": 30
      },
      {
        "ink": "orange",
        "drops": 10
      },
      {
        "ink": "green",
        "drops": 2
      }
    ]
  },
  "Equal parts - White and blue": {
    "label": "Equal parts - White and blue",
    "rgb": [
      57,
      89,
      152
    ],
    "components": [
      {
        "ink": "white",
        "drops": 20
      },
      {
        "ink": "blue",
        "drops": 20
      }
    ]
  },
  "20 drops of white + 6 drops of blue": {
    "label": "20 drops of white + 6 drops of blue",
    "rgb": [
      59,
      99,
      159
    ],
    "components": [
      {
        "ink": "white",
        "drops": 20
      },
      {
        "ink": "blue",
        "drops": 6
      }
    ]
  },
  "40 drops of white + 3 drops of blue": {
    "label": "40 drops of white + 3 drops of blue",
    "rgb": [
      77,
      141,
      189
    ],
    "components": [
      {
        "ink": "white",
        "drops": 40
      },
      {
        "ink": "blue",
        "drops": 3
      }
    ]
  },
  "60 drops of white + 1 drop of blue": {
    "label": "60 drops of white + 1 drop of blue",
    "rgb": [
      108,
      188,
      221
    ],
    "components": [
      {
        "ink": "white",
        "drops": 60
      },
      {
        "ink": "blue",
        "drops": 1
      }
    ]
  },
  "50 drops of white + 1 drop of green": {
    "label": "50 drops of white + 1 drop of green",
    "rgb": [
      119,
      196,
      188
    ],
    "components": [
      {
        "ink": "white",
        "drops": 50
      },
      {
        "ink": "green",
        "drops": 1
      }
    ]
  },
  "25 drops of white + 1 drop of green": {
    "label": "25 drops of white + 1 drop of green",
    "rgb": [
      68,
      182,
      169
    ],
    "components": [
      {
        "ink": "white",
        "drops": 25
      },
      {
        "ink": "green",
        "drops": 1
      }
    ]
  },
  "25 drops of white + 6 drops of green": {
    "label": "25 drops of white + 6 drops of green",
    "rgb": [
      40,
      144,
      127
    ],
    "components": [
      {
        "ink": "white",
        "drops": 25
      },
      {
        "ink": "green",
        "drops": 6
      }
    ]
  },
  "Equal parts - White and green": {
    "label": "Equal parts - White and green",
    "rgb": [
      27,
      110,
      100
    ],
    "components": [
      {
        "ink": "white",
        "drops": 20
      },
      {
        "ink": "green",
        "drops": 20
      }
    ]
  },
  "20 drops of green + 10 drops of white": {
    "label": "20 drops of green + 10 drops of white",
    "rgb": [
      17,
      81,
      67
    ],
    "components": [
      {
        "ink": "white",
        "drops": 10
      },
      {
        "ink": "green",
        "drops": 20
      }
    ]
  },
  "Equal parts - Yellow and blue": {
    "label": "Equal parts - Yellow and blue",
    "rgb": [
      21,
      52,
      45
    ],
    "components": [
      {
        "ink": "yellow",
        "drops": 20
      },
      {
        "ink": "blue",
        "drops": 20
      }
    ]
  },
  "20 drops of yellow + 8 drops of blue": {
    "label": "20 drops of yellow + 8 drops of blue",
    "rgb": [
      18,
      54,
      32
    ],
    "components": [
      {
        "ink": "yellow",
        "drops": 20
      },
      {
        "ink": "blue",
        "drops": 8
      }
    ]
  },
  "20 drops of yellow + 1 drop of blue": {
    "label": "20 drops of yellow + 1 drop of blue",
    "rgb": [
      55,
      112,
      59
    ],
    "components": [
      {
        "ink": "yellow",
        "drops": 20
      },
      {
        "ink": "blue",
        "drops": 1
      }
    ]
  },
  "25 drops of white + 3 drops of green + 2 drops of blue": {
    "label": "25 drops of white + 3 drops of green + 2 drops of blue",
    "rgb": [
      36,
      118,
      128
    ],
    "components": [
      {
        "ink": "white",
        "drops": 25
      },
      {
        "ink": "blue",
        "drops": 2
      },
      {
        "ink": "green",
        "drops": 3
      }
    ]
  },
  "40 drops of white + 2 drops of green + 1 drop of blue": {
    "label": "40 drops of white + 2 drops of green + 1 drop of blue",
    "rgb": [
      93,
      157,
      167
    ],
    "components": [
      {
        "ink": "white",
        "drops": 40
      },
      {
        "ink": "blue",
        "drops": 1
      },
      {
        "ink": "green",
        "drops": 2
      }
    ]
  },
  "50 drops of white + 2 drops of yellow + 1 drop of blue + 1 drop of green": {
    "label": "50 drops of white + 2 drops of yellow + 1 drop of blue + 1 drop of green",
    "rgb": [
      84,
      162,
      146
    ],
    "components": [
      {
        "ink": "white",
        "drops": 50
      },
      {
        "ink": "yellow",
        "drops": 2
      },
      {
        "ink": "blue",
        "drops": 1
      },
      {
        "ink": "green",
        "drops": 1
      }
    ]
  },
  "25 drops of white + 2 drops of yellow + 1 drop of blue + 1 drop of green": {
    "label": "25 drops of white + 2 drops of yellow + 1 drop of blue + 1 drop of green",
    "rgb": [
      75,
      147,
      134
    ],
    "components": [
      {
        "ink": "white",
        "drops": 25
      },
      {
        "ink": "yellow",
        "drops": 2
      },
      {
        "ink": "blue",
        "drops": 1
      },
      {
        "ink": "green",
        "drops": 1
      }
    ]
  },
  "20 drops of white + 4 drops of yellow + 3 drops of blue + 3 drops of green": {
    "label": "20 drops of white + 4 drops of yellow + 3 drops of blue + 3 drops of green",
    "rgb": [
      37,
      83,
      94
    ],
    "components": [
      {
        "ink": "white",
        "drops": 20
      },
      {
        "ink": "yellow",
        "drops": 4
      },
      {
        "ink": "blue",
        "drops": 3
      },
      {
        "ink": "green",
        "drops": 3
      }
    ]
  },
  "15 drops of blue + 10 drops of green + 5 drops of white": {
    "label": "15 drops of blue + 10 drops of green + 5 drops of white",
    "rgb": [
      23,
      56,
      64
    ],
    "components": [
      {
        "ink": "white",
        "drops": 5
      },
      {
        "ink": "blue",
        "drops": 15
      },
      {
        "ink": "green",
        "drops": 10
      }
    ]
  },
  "Equal parts - White, green and yellow": {
    "label": "Equal parts - White, green and yellow",
    "rgb": [
      48,
      117,
      70
    ],
    "components": [
      {
        "ink": "white",
        "drops": 20
      },
      {
        "ink": "yellow",
        "drops": 20
      },
      {
        "ink": "green",
        "drops": 20
      }
    ]
  },
  "15 drops of yellow + 5 drops of white + 3 drops of green + 2 drops of blue": {
    "label": "15 drops of yellow + 5 drops of white + 3 drops of green + 2 drops of blue",
    "rgb": [
      31,
      71,
      63
    ],
    "components": [
      {
        "ink": "white",
        "drops": 5
      },
      {
        "ink": "yellow",
        "drops": 15
      },
      {
        "ink": "blue",
        "drops": 2
      },
      {
        "ink": "green",
        "drops": 3
      }
    ]
  },
  "Equal parts - White, blue and yellow": {
    "label": "Equal parts - White, blue and yellow",
    "rgb": [
      31,
      71,
      63
    ],
    "components": [
      {
        "ink": "white",
        "drops": 20
      },
      {
        "ink": "yellow",
        "drops": 20
      },
      {
        "ink": "blue",
        "drops": 20
      }
    ]
  },
  "20 drops of yellow + 2 drops of black + 2 drops of white": {
    "label": "20 drops of yellow + 2 drops of black + 2 drops of white",
    "rgb": [
      69,
      79,
      55
    ],
    "components": [
      {
        "ink": "white",
        "drops": 2
      },
      {
        "ink": "yellow",
        "drops": 20
      },
      {
        "ink": "black",
        "drops": 2
      }
    ]
  },
  "25 drops of yellow + 5 drops of red + 1 drop of green": {
    "label": "25 drops of yellow + 5 drops of red + 1 drop of green",
    "rgb": [
      79,
      71,
      51
    ],
    "components": [
      {
        "ink": "yellow",
        "drops": 25
      },
      {
        "ink": "red",
        "drops": 5
      },
      {
        "ink": "green",
        "drops": 1
      }
    ]
  },
  "50 drops of white + 10 drops of yellow + 1 drop of orange + 1 drop of magenta": {
    "label": "50 drops of white + 10 drops of yellow + 1 drop of orange + 1 drop of magenta",
    "rgb": [
      123,
      118,
      109
    ],
    "components": [
      {
        "ink": "white",
        "drops": 50
      },
      {
        "ink": "yellow",
        "drops": 10
      },
      {
        "ink": "orange",
        "drops": 1
      },
      {
        "ink": "magenta",
        "drops": 1
      }
    ]
  },
  "60 drops of white + 5 drops of orange + 3 drops of red + 1 drop of blue": {
    "label": "60 drops of white + 5 drops of orange + 3 drops of red + 1 drop of blue",
    "rgb": [
      114,
      99,
      88
    ],
    "components": [
      {
        "ink": "white",
        "drops": 60
      },
      {
        "ink": "orange",
        "drops": 5
      },
      {
        "ink": "red",
        "drops": 3
      },
      {
        "ink": "blue",
        "drops": 1
      }
    ]
  },
  "12 drops of white + 10 drops of red + 5 drops of orange + 2 drops of blue": {
    "label": "12 drops of white + 10 drops of red + 5 drops of orange + 2 drops of blue",
    "rgb": [
      115,
      99,
      88
    ],
    "components": [
      {
        "ink": "white",
        "drops": 12
      },
      {
        "ink": "orange",
        "drops": 5
      },
      {
        "ink": "red",
        "drops": 10
      },
      {
        "ink": "blue",
        "drops": 2
      }
    ]
  },
  "20 drops of red + 10 drops of magenta + 1 drop of green + 1 drop of violet": {
    "label": "20 drops of red + 10 drops of magenta + 1 drop of green + 1 drop of violet",
    "rgb": [
      62,
      39,
      32
    ],
    "components": [
      {
        "ink": "red",
        "drops": 20
      },
      {
        "ink": "magenta",
        "drops": 10
      },
      {
        "ink": "violet",
        "drops": 1
      },
      {
        "ink": "green",
        "drops": 1
      }
    ]
  },
  "Equal parts - Orange and magenta": {
    "label": "Equal parts - Orange and magenta",
    "rgb": [
      133,
      33,
      36
    ],
    "components": [
      {
        "ink": "orange",
        "drops": 20
      },
      {
        "ink": "magenta",
        "drops": 20
      }
    ]
  },
  "Equal parts - Orange and red": {
    "label": "Equal parts - Orange and red",
    "rgb": [
      178,
      41,
      43
    ],
    "components": [
      {
        "ink": "orange",
        "drops": 20
      },
      {
        "ink": "red",
        "drops": 20
      }
    ]
  },
  "Equal parts - White, yellow and red": {
    "label": "Equal parts - White, yellow and red",
    "rgb": [
      169,
      84,
      82
    ],
    "components": [
      {
        "ink": "white",
        "drops": 20
      },
      {
        "ink": "yellow",
        "drops": 20
      },
      {
        "ink": "red",
        "drops": 20
      }
    ]
  },
  "20 drops of white + 8 drops of black + 1 drop of blue": {
    "label": "20 drops of white + 8 drops of black + 1 drop of blue",
    "rgb": [
      37,
      45,
      56
    ],
    "components": [
      {
        "ink": "white",
        "drops": 20
      },
      {
        "ink": "blue",
        "drops": 1
      },
      {
        "ink": "black",
        "drops": 8
      }
    ]
  },
  "25 drops of white + 4 drops of black + 1 drop of blue": {
    "label": "25 drops of white + 4 drops of black + 1 drop of blue",
    "rgb": [
      56,
      78,
      90
    ],
    "components": [
      {
        "ink": "white",
        "drops": 25
      },
      {
        "ink": "blue",
        "drops": 1
      },
      {
        "ink": "black",
        "drops": 4
      }
    ]
  },
  "40 drops of white + 2 drops of black + 1 drop of blue": {
    "label": "40 drops of white + 2 drops of black + 1 drop of blue",
    "rgb": [
      92,
      119,
      136
    ],
    "components": [
      {
        "ink": "white",
        "drops": 40
      },
      {
        "ink": "blue",
        "drops": 1
      },
      {
        "ink": "black",
        "drops": 2
      }
    ]
  },
  "30 drops of white + 3 drops of blue + 2 drops of black": {
    "label": "30 drops of white + 3 drops of blue + 2 drops of black",
    "rgb": [
      44,
      80,
      95
    ],
    "components": [
      {
        "ink": "white",
        "drops": 30
      },
      {
        "ink": "blue",
        "drops": 3
      },
      {
        "ink": "black",
        "drops": 2
      }
    ]
  },
  "60 drops of white + 1 drop of black + 1 drop of blue": {
    "label": "60 drops of white + 1 drop of black + 1 drop of blue",
    "rgb": [
      44,
      80,
      143
    ],
    "components": [
      {
        "ink": "white",
        "drops": 60
      },
      {
        "ink": "blue",
        "drops": 1
      },
      {
        "ink": "black",
        "drops": 1
      }
    ]
  },
  "30 drops of white + 15 drops of black": {
    "label": "30 drops of white + 15 drops of black",
    "rgb": [
      46,
      50,
      51
    ],
    "components": [
      {
        "ink": "white",
        "drops": 30
      },
      {
        "ink": "black",
        "drops": 15
      }
    ]
  },
  "50 drops of white + 1 drop of yellow + 1 drop of red": {
    "label": "50 drops of white + 1 drop of yellow + 1 drop of red",
    "rgb": [
      232,
      181,
      176
    ],
    "components": [
      {
        "ink": "white",
        "drops": 50
      },
      {
        "ink": "yellow",
        "drops": 1
      },
      {
        "ink": "red",
        "drops": 1
      }
    ]
  },
  "20 drops of white + 2 drops of yellow + 2 drops of magenta + 2 drops of orange": {
    "label": "20 drops of white + 2 drops of yellow + 2 drops of magenta + 2 drops of orange",
    "rgb": [
      196,
      139,
      136
    ],
    "components": [
      {
        "ink": "white",
        "drops": 20
      },
      {
        "ink": "yellow",
        "drops": 2
      },
      {
        "ink": "orange",
        "drops": 2
      },
      {
        "ink": "magenta",
        "drops": 2
      }
    ]
  },
  "25 drops of white + 5 drops of yellow + 3 drops of magenta": {
    "label": "25 drops of white + 5 drops of yellow + 3 drops of magenta",
    "rgb": [
      179,
      123,
      118
    ],
    "components": [
      {
        "ink": "white",
        "drops": 25
      },
      {
        "ink": "yellow",
        "drops": 5
      },
      {
        "ink": "magenta",
        "drops": 3
      }
    ]
  },
  "30 drops of white + 2 drops of yellow + 1 drops of magenta": {
    "label": "30 drops of white + 2 drops of yellow + 1 drops of magenta",
    "rgb": [
      218,
      163,
      150
    ],
    "components": [
      {
        "ink": "white",
        "drops": 30
      },
      {
        "ink": "yellow",
        "drops": 2
      },
      {
        "ink": "magenta",
        "drops": 1
      }
    ]
  },
  "20 drops of white + 2 drops of magenta + 2 drops of yellow": {
    "label": "20 drops of white + 2 drops of magenta + 2 drops of yellow",
    "rgb": [
      188,
      141,
      141
    ],
    "components": [
      {
        "ink": "white",
        "drops": 20
      },
      {
        "ink": "yellow",
        "drops": 2
      },
      {
        "ink": "magenta",
        "drops": 2
      }
    ]
  },
  "20 drops of white + 3 drops of magenta + 3 drops of orange": {
    "label": "20 drops of white + 3 drops of magenta + 3 drops of orange",
    "rgb": [
      187,
      115,
      119
    ],
    "components": [
      {
        "ink": "white",
        "drops": 20
      },
      {
        "ink": "orange",
        "drops": 3
      },
      {
        "ink": "magenta",
        "drops": 3
      }
    ]
  },
  "40 drops of white + 5 drops of magenta + 5 drops of orange": {
    "label": "40 drops of white + 5 drops of magenta + 5 drops of orange",
    "rgb": [
      192,
      105,
      114
    ],
    "components": [
      {
        "ink": "white",
        "drops": 40
      },
      {
        "ink": "orange",
        "drops": 5
      },
      {
        "ink": "magenta",
        "drops": 5
      }
    ]
  },
  "Equal parts - Orange, white and magenta": {
    "label": "Equal parts - Orange, white and magenta",
    "rgb": [
      147,
      82,
      88
    ],
    "components": [
      {
        "ink": "white",
        "drops": 20
      },
      {
        "ink": "orange",
        "drops": 20
      },
      {
        "ink": "magenta",
        "drops": 20
      }
    ]
  },
  "20 drops of red + 15 drops of white + 5 drops of magenta": {
    "label": "20 drops of red + 15 drops of white + 5 drops of magenta",
    "rgb": [
      118,
      38,
      57
    ],
    "components": [
      {
        "ink": "white",
        "drops": 15
      },
      {
        "ink": "red",
        "drops": 20
      },
      {
        "ink": "magenta",
        "drops": 5
      }
    ]
  },
  "Equal parts - Yellow and magenta": {
    "label": "Equal parts - Yellow and magenta",
    "rgb": [
      124,
      48,
      50
    ],
    "components": [
      {
        "ink": "yellow",
        "drops": 20
      },
      {
        "ink": "magenta",
        "drops": 20
      }
    ]
  },
  "Equal parts - White, yellow and magenta": {
    "label": "Equal parts - White, yellow and magenta",
    "rgb": [
      159,
      85,
      84
    ],
    "components": [
      {
        "ink": "white",
        "drops": 20
      },
      {
        "ink": "yellow",
        "drops": 20
      },
      {
        "ink": "magenta",
        "drops": 20
      }
    ]
  },
  "20 drops of yellow + 4 drops of magenta + 2 drops of red": {
    "label": "20 drops of yellow + 4 drops of magenta + 2 drops of red",
    "rgb": [
      157,
      88,
      73
    ],
    "components": [
      {
        "ink": "yellow",
        "drops": 20
      },
      {
        "ink": "red",
        "drops": 2
      },
      {
        "ink": "magenta",
        "drops": 4
      }
    ]
  },
  "40 drops of white + 8 drops of yellow + 4 drops of red + 1 drop of green": {
    "label": "40 drops of white + 8 drops of yellow + 4 drops of red + 1 drop of green",
    "rgb": [
      126,
      114,
      103
    ],
    "components": [
      {
        "ink": "white",
        "drops": 40
      },
      {
        "ink": "yellow",
        "drops": 8
      },
      {
        "ink": "red",
        "drops": 4
      },
      {
        "ink": "green",
        "drops": 1
      }
    ]
  },
  "20 drops of white + 10 drops of yellow + 5 drops of red + 1 drop of green": {
    "label": "20 drops of white + 10 drops of yellow + 5 drops of red + 1 drop of green",
    "rgb": [
      91,
      81,
      72
    ],
    "components": [
      {
        "ink": "white",
        "drops": 20
      },
      {
        "ink": "yellow",
        "drops": 10
      },
      {
        "ink": "red",
        "drops": 5
      },
      {
        "ink": "green",
        "drops": 1
      }
    ]
  },
  "50 drops of white + 10 drops of yellow + 10 drops of orange + 2 drops of red + 1 drop of blue": {
    "label": "50 drops of white + 10 drops of yellow + 10 drops of orange + 2 drops of red + 1 drop of blue",
    "rgb": [
      100,
      86,
      75
    ],
    "components": [
      {
        "ink": "white",
        "drops": 50
      },
      {
        "ink": "yellow",
        "drops": 10
      },
      {
        "ink": "orange",
        "drops": 10
      },
      {
        "ink": "red",
        "drops": 2
      },
      {
        "ink": "blue",
        "drops": 1
      }
    ]
  },
  "30 drops of white + 20 drops of yellow + 15 drops of orange + 10 drops of red + 1 drop of blue": {
    "label": "30 drops of white + 20 drops of yellow + 15 drops of orange + 10 drops of red + 1 drop of blue",
    "rgb": [
      100,
      67,
      60
    ],
    "components": [
      {
        "ink": "white",
        "drops": 30
      },
      {
        "ink": "yellow",
        "drops": 20
      },
      {
        "ink": "orange",
        "drops": 15
      },
      {
        "ink": "red",
        "drops": 10
      },
      {
        "ink": "blue",
        "drops": 1
      }
    ]
  },
  "25 drops of red + 10 drops of white + 1 drop of blue": {
    "label": "25 drops of red + 10 drops of white + 1 drop of blue",
    "rgb": [
      76,
      33,
      43
    ],
    "components": [
      {
        "ink": "white",
        "drops": 10
      },
      {
        "ink": "red",
        "drops": 25
      },
      {
        "ink": "blue",
        "drops": 1
      }
    ]
  },
  "25 drops of red + 1 drop of blue": {
    "label": "25 drops of red + 1 drop of blue",
    "rgb": [
      56,
      16,
      19
    ],
    "components": [
      {
        "ink": "red",
        "drops": 25
      },
      {
        "ink": "blue",
        "drops": 1
      }
    ]
  },
  "20 drops of red + 1 drop of black": {
    "label": "20 drops of red + 1 drop of black",
    "rgb": [
      64,
      37,
      34
    ],
    "components": [
      {
        "ink": "red",
        "drops": 20
      },
      {
        "ink": "black",
        "drops": 1
      }
    ]
  },
  "20 drops of red + 20 drops of white + 1 drop of black": {
    "label": "20 drops of red + 20 drops of white + 1 drop of black",
    "rgb": [
      80,
      49,
      57
    ],
    "components": [
      {
        "ink": "white",
        "drops": 20
      },
      {
        "ink": "red",
        "drops": 20
      },
      {
        "ink": "black",
        "drops": 1
      }
    ]
  },
  "20 drops of white + 20 drops of red + 1 drop of blue": {
    "label": "20 drops of white + 20 drops of red + 1 drop of blue",
    "rgb": [
      63,
      37,
      48
    ],
    "components": [
      {
        "ink": "white",
        "drops": 20
      },
      {
        "ink": "red",
        "drops": 20
      },
      {
        "ink": "blue",
        "drops": 1
      }
    ]
  },
  "40 drops of white + 15 drops of red + 1 drop of blue": {
    "label": "40 drops of white + 15 drops of red + 1 drop of blue",
    "rgb": [
      102,
      84,
      100
    ],
    "components": [
      {
        "ink": "white",
        "drops": 40
      },
      {
        "ink": "red",
        "drops": 15
      },
      {
        "ink": "blue",
        "drops": 1
      }
    ]
  },
  "50 drops of white + 3 drops of magenta + 2 drops of yellow": {
    "label": "50 drops of white + 3 drops of magenta + 2 drops of yellow",
    "rgb": [
      228,
      164,
      178
    ],
    "components": [
      {
        "ink": "white",
        "drops": 50
      },
      {
        "ink": "yellow",
        "drops": 2
      },
      {
        "ink": "magenta",
        "drops": 3
      }
    ]
  },
  "25 drops of white + 2 drops of yellow + 1 drop of red": {
    "label": "25 drops of white + 2 drops of yellow + 1 drop of red",
    "rgb": [
      222,
      154,
      145
    ],
    "components": [
      {
        "ink": "white",
        "drops": 25
      },
      {
        "ink": "yellow",
        "drops": 2
      },
      {
        "ink": "red",
        "drops": 1
      }
    ]
  },
  "25 drops of white + 5 drops of magenta": {
    "label": "25 drops of white + 5 drops of magenta",
    "rgb": [
      160,
      106,
      158
    ],
    "components": [
      {
        "ink": "white",
        "drops": 25
      },
      {
        "ink": "magenta",
        "drops": 5
      }
    ]
  },
  "Equal parts - White and magenta": {
    "label": "Equal parts - White and magenta",
    "rgb": [
      156,
      76,
      140
    ],
    "components": [
      {
        "ink": "white",
        "drops": 20
      },
      {
        "ink": "magenta",
        "drops": 20
      }
    ]
  },
  "20 drops of magenta + 10 drops of white": {
    "label": "20 drops of magenta + 10 drops of white",
    "rgb": [
      105,
      47,
      88
    ],
    "components": [
      {
        "ink": "white",
        "drops": 10
      },
      {
        "ink": "magenta",
        "drops": 20
      }
    ]
  },
  "25 drops of magenta + 10 drops of white + 2 drops of violet": {
    "label": "25 drops of magenta + 10 drops of white + 2 drops of violet",
    "rgb": [
      89,
      38,
      70
    ],
    "components": [
      {
        "ink": "white",
        "drops": 10
      },
      {
        "ink": "magenta",
        "drops": 25
      },
      {
        "ink": "violet",
        "drops": 2
      }
    ]
  },
  "10 drops of magenta + 10 drops of white + 1 drop of violet": {
    "label": "10 drops of magenta + 10 drops of white + 1 drop of violet",
    "rgb": [
      72,
      54,
      96
    ],
    "components": [
      {
        "ink": "white",
        "drops": 10
      },
      {
        "ink": "magenta",
        "drops": 10
      },
      {
        "ink": "violet",
        "drops": 1
      }
    ]
  },
  "25 drops of white + 4 drops of magenta + 1 drop of violet": {
    "label": "25 drops of white + 4 drops of magenta + 1 drop of violet",
    "rgb": [
      109,
      95,
      153
    ],
    "components": [
      {
        "ink": "white",
        "drops": 25
      },
      {
        "ink": "magenta",
        "drops": 4
      },
      {
        "ink": "violet",
        "drops": 1
      }
    ]
  },
  "40 drops of white + 1 drop of violet": {
    "label": "40 drops of white + 1 drop of violet",
    "rgb": [
      123,
      113,
      166
    ],
    "components": [
      {
        "ink": "white",
        "drops": 40
      },
      {
        "ink": "violet",
        "drops": 1
      }
    ]
  },
  "20 drops of white + 1 drop of violet": {
    "label": "20 drops of white + 1 drop of violet",
    "rgb": [
      91,
      91,
      152
    ],
    "components": [
      {
        "ink": "white",
        "drops": 20
      },
      {
        "ink": "violet",
        "drops": 1
      }
    ]
  },
  "20 drops of white + 5 drops of violet": {
    "label": "20 drops of white + 5 drops of violet",
    "rgb": [
      48,
      49,
      119
    ],
    "components": [
      {
        "ink": "white",
        "drops": 20
      },
      {
        "ink": "violet",
        "drops": 5
      }
    ]
  },
  "Equal parts - White and violet": {
    "label": "Equal parts - White and violet",
    "rgb": [
      35,
      36,
      65
    ],
    "components": [
      {
        "ink": "white",
        "drops": 20
      },
      {
        "ink": "violet",
        "drops": 20
      }
    ]
  },
  "20 drops of blue + 10 drops of white": {
    "label": "20 drops of blue + 10 drops of white",
    "rgb": [
      39,
      54,
      110
    ],
    "components": [
      {
        "ink": "white",
        "drops": 10
      },
      {
        "ink": "blue",
        "drops": 20
      }
    ]
  },
  "30 drops of white + 7 drops of black": {
    "label": "30 drops of white + 7 drops of black",
    "rgb": [
      89,
      98,
      106
    ],
    "components": [
      {
        "ink": "white",
        "drops": 30
      },
      {
        "ink": "black",
        "drops": 7
      }
    ]
  },
  "30 drops of white + 3 drops of black": {
    "label": "30 drops of white + 3 drops of black",
    "rgb": [
      112,
      125,
      132
    ],
    "components": [
      {
        "ink": "white",
        "drops": 30
      },
      {
        "ink": "black",
        "drops": 3
      }
    ]
  },
  "40 drops of white + 1 drop of black": {
    "label": "40 drops of white + 1 drop of black",
    "rgb": [
      137,
      149,
      155
    ],
    "components": [
      {
        "ink": "white",
        "drops": 40
      },
      {
        "ink": "black",
        "drops": 1
      }
    ]
  },
  "60 drops of white + 1 drop of black": {
    "label": "60 drops of white + 1 drop of black",
    "rgb": [
      182,
      190,
      191
    ],
    "components": [
      {
        "ink": "white",
        "drops": 60
      },
      {
        "ink": "black",
        "drops": 1
      }
    ]
  },
  "20 drops of white + 10 drops of yellow + 5 drops of red + 2 drops of blue": {
    "label": "20 drops of white + 10 drops of yellow + 5 drops of red + 2 drops of blue",
    "rgb": [
      80,
      87,
      80
    ],
    "components": [
      {
        "ink": "white",
        "drops": 20
      },
      {
        "ink": "yellow",
        "drops": 10
      },
      {
        "ink": "red",
        "drops": 5
      },
      {
        "ink": "blue",
        "drops": 2
      }
    ]
  },
  "20 drops of white + 6 drops of yellow + 2 drops of red + 1 drop of blue": {
    "label": "20 drops of white + 6 drops of yellow + 2 drops of red + 1 drop of blue",
    "rgb": [
      95,
      97,
      99
    ],
    "components": [
      {
        "ink": "white",
        "drops": 20
      },
      {
        "ink": "yellow",
        "drops": 6
      },
      {
        "ink": "red",
        "drops": 2
      },
      {
        "ink": "blue",
        "drops": 1
      }
    ]
  },
  "40 drops of white + 8 drops of yellow + 1 drop of red + 1 drop of blue": {
    "label": "40 drops of white + 8 drops of yellow + 1 drop of red + 1 drop of blue",
    "rgb": [
      104,
      130,
      127
    ],
    "components": [
      {
        "ink": "white",
        "drops": 40
      },
      {
        "ink": "yellow",
        "drops": 8
      },
      {
        "ink": "red",
        "drops": 1
      },
      {
        "ink": "blue",
        "drops": 1
      }
    ]
  },
  "40 drops of white + 2 drops of orange + 1 drop of black": {
    "label": "40 drops of white + 2 drops of orange + 1 drop of black",
    "rgb": [
      125,
      120,
      114
    ],
    "components": [
      {
        "ink": "white",
        "drops": 40
      },
      {
        "ink": "orange",
        "drops": 2
      },
      {
        "ink": "black",
        "drops": 1
      }
    ]
  },
  "40 drops of white + 4 drops of orange + 3 drops of black": {
    "label": "40 drops of white + 4 drops of orange + 3 drops of black",
    "rgb": [
      97,
      90,
      86
    ],
    "components": [
      {
        "ink": "white",
        "drops": 40
      },
      {
        "ink": "orange",
        "drops": 4
      },
      {
        "ink": "black",
        "drops": 3
      }
    ]
  },
  "40 drops of white + 10 drops of orange + 6 drops of black": {
    "label": "40 drops of white + 10 drops of orange + 6 drops of black",
    "rgb": [
      79,
      74,
      69
    ],
    "components": [
      {
        "ink": "white",
        "drops": 40
      },
      {
        "ink": "orange",
        "drops": 10
      },
      {
        "ink": "black",
        "drops": 6
      }
    ]
  },
  "40 drops of white + 10 drops of black + 2 drops of violet": {
    "label": "40 drops of white + 10 drops of black + 2 drops of violet",
    "rgb": [
      52,
      60,
      73
    ],
    "components": [
      {
        "ink": "white",
        "drops": 40
      },
      {
        "ink": "violet",
        "drops": 2
      },
      {
        "ink": "black",
        "drops": 10
      }
    ]
  },
  "40 drops of white + 3 drops of black + 1 drop of violet": {
    "label": "40 drops of white + 3 drops of black + 1 drop of violet",
    "rgb": [
      78,
      86,
      90
    ],
    "components": [
      {
        "ink": "white",
        "drops": 40
      },
      {
        "ink": "violet",
        "drops": 1
      },
      {
        "ink": "black",
        "drops": 3
      }
    ]
  }
};

/* Brand base inks (your file already defines them above the recipes in the working version) */
const brandBaseInks = {
  /* Keep your existing brand dictionaries here (unchanged) ‚Äî if they are already in your file above the recipes, copy them over as-is. */
  /* Example minimal stub so the app boots even before you paste: */
  "Radiant Colors": { "Black": "#0A0A0A", "White": "#FFFFFF", "Yellow": "#F9E14B", "Red": "#D62828", "Blue": "#2066C5", "Green": "#1F8A4C", "Orange": "#ED7D31", "Magenta": "#E23074", "Violet": "#6B4FB3" }
};

/* Combine recipes + base inks into master map */
const ALL_AVAILABLE_INKS_AND_RECIPES = { ...recipesFromCSV };
for(const brand in brandBaseInks){
  for(const inkName in brandBaseInks[brand]){
    const full = `${brand} ${inkName}`;
    ALL_AVAILABLE_INKS_AND_RECIPES[full] = { label: full, rgb: hexToRgb(brandBaseInks[brand][inkName]), components: [{ink: full, drops:1}] };
  }
}
ALL_AVAILABLE_INKS_AND_RECIPES["Black Ink"] = { label:"Black Ink", rgb: hexToRgb("#0A0A0A"), components:[{ink:"Black Ink", drops:1}] };

const RECIPES = ALL_AVAILABLE_INKS_AND_RECIPES;
const ALL_RECIPES_LABS = Object.entries(RECIPES).map(([name,data]) => ({ name, ...data, lab: rgbToLab(...data.rgb) }));
function delta(a,b){ return deltaE2000(a,b); }
function nearestInk(lab){
  let best=null, bestD=Infinity;
  for(const item of ALL_RECIPES_LABS){
    const d=delta(lab,item.lab);
    if(d<bestD){ bestD=d; best=item; }
  }
  return best;
}

/* Map core9 ‚Üí closest brand inks */
const CORE9_MAPPING = {};
(function buildCore9(){
  const genericBlack = { name:"Black Ink", lab: rgbToLab(...hexToRgb("#0A0A0A")) };
  for(const brand of Object.keys(brandBaseInks)){
    const brandInks = Object.entries(brandBaseInks[brand]).map(([n,hex])=>({name:`${brand} ${n}`, lab: rgbToLab(...hexToRgb(hex))}));
    CORE9_MAPPING[brand] = CORE9_COLORS.map(core=>{
      if(core.name==='black') return genericBlack;
      let best=null, minD=Infinity;
      for(const ink of brandInks){
        const d = deltaE2000(core.lab, ink.lab);
        if(d<minD){ minD=d; best=ink; }
      }
      return best;
    });
  }
})();

/* ===== Panels / Builders (unchanged logic, just always accessible from top bar) ===== */
function swatchHtml(name,color, dataAttr='data-core9', removeBtn=false, showName=true){
  return `<div class='swatch' ${dataAttr}='${name}'>
    <div class='dot' style='background:${color}'></div>
    ${showName?`<div class='name'>${name}</div>`:''}
    ${removeBtn?`<button class='remove-btn' data-action='remove-swatch'>&times;</button>`:''}
  </div>`;
}

function buildIntegral(canvas, ctx){
      const w=canvas.width,h=canvas.height, data=ctx.getImageData(0,0,w,h).data;
      const I=new Float64Array((w+1)*(h+1)*3); const idx=(x,y,c)=>((y*(w+1)+x)*3+c);
      for(let y=1;y<=h;y++){ let rowR=0,rowG=0,rowB=0;
        for(let x=1;x<=w;x++){ const p=((y-1)*w+(x-1))*4; rowR+=data[p]; rowG+=data[p+1]; rowB+=data[p+2];
          I[idx(x,y,0)]=I[idx(x,y-1,0)]+rowR; I[idx(x,y,1)]=I[idx(x,y-1,1)]+rowG; I[idx(x,y,2)]=I[idx(x,y-1,2)]+rowB; } }
      return {I,w,h,idx};
    }
function avgRegion(integral,x0,y0,x1,y1){
  const {I,idx}=integral, A=(x,y,c)=>I[idx(x,y,c)], area=(x1-x0)*(y1-y0);
  if(area===0) return [0,0,0];
  const r=A(x1,y1,0)-A(x0,y1,0)-A(x1,y0,0)+A(x0,y0,0);
  const g=A(x1,y1,1)-A(x0,y1,1)-A(x1,y0,1)+A(x0,y0,1);
  const b=A(x1,y1,2)-A(x0,y1,2)-A(x1,y0,2)+A(x0,y0,2);
  return [r/area,g/area,b/area];
}

const builders={
  import:()=>makePanel({id:'p-import',title:'Import Image',content:`
    <input type='file' id='fileInput' accept='image/*' style='display:none'>
    <div class='row'><button class='btn' id='btnChoose'>Choose Image</button><button class='btn' id='btnClear'>Clear</button></div>
    <div class='row'><span class='label'>Crop</span>
      <select class='select' id="cropRatio">
        <option value="free">Free</option>
        <option value="1">1:1 (Square)</option>
        <option value="1.777">16:9 (Landscape)</option>
        <option value="0.5625">9:16 (Portrait)</option>
      </select>
    </div>
    <div class='row' style='justify-content:flex-end'><button class='btn primary' id='btnApplyCrop'>Apply Crop</button></div>
  `, onopen:(p)=>{
    const fi=$('#fileInput',p), btn=$('#btnChoose',p), clr=$('#btnClear',p), applyBtn=$('#btnApplyCrop',p);
    btn.onclick=()=>fi.click();
    fi.onchange=(e)=>{ const f=e.target.files?.[0]; if(f) loadImage(f); };
    clr.onclick=()=>{ appState.img=null; render(); };
    applyBtn.onclick=()=>{ alertUser("Crop applied!"); render(); };
  }}),

  details:()=>makePanel({id:'p-details',title:'Project Details',width:330,content:`
    <div class='row'><label class='label'>Client Name</label><input type='text' id='clientName'></div>
    <div class='row'><label class='label'>Tattoo Concept</label><input type='text' id='tattooConcept'></div>
    <div class='row'><label class='label'>Placement</label><input type='text' id='tattooPlacement'></div>
    <div class='col'><label class='label'>Notes</label><textarea id='tattooNotes'></textarea></div>
  `, onopen:(p)=>{
    const n=$('#clientName',p), c=$('#tattooConcept',p), pl=$('#tattooPlacement',p), no=$('#tattooNotes',p);
    n.value=appState.projectDetails.clientName||''; c.value=appState.projectDetails.concept||''; pl.value=appState.projectDetails.placement||''; no.value=appState.projectDetails.notes||'';
    const save=()=>{ appState.projectDetails={clientName:n.value,concept:c.value,placement:pl.value,notes:no.value}; saveAppState(); };
    n.oninput=save; c.oninput=save; pl.oninput=save; no.oninput=save;
  }}),

  brightness:()=>makePanel({id:'p-bright',title:'Brightness',content:`
    <input id='brightSlider' type='range' class='slider' min='-100' max='100' value='0'>
  `, onopen:(p)=>{
    const sl=$('#brightSlider',p); sl.value=appState.brightness; sl.oninput=()=>{ appState.brightness=+sl.value; render(); saveAppState(); };
  }}),

  saturation:()=>makePanel({id:'p-sat',title:'Saturation',content:`
    <input id='satSlider' type='range' class='slider' min='-100' max='100' value='0'>
  `, onopen:(p)=>{
    const sl=$('#satSlider',p); sl.value=appState.saturation; sl.oninput=()=>{ appState.saturation=+sl.value; render(); saveAppState(); };
  }}),

  export:()=>makePanel({id:'p-export',title:'Export',content:`
    <div class='label'>Reference sheet will include: Canvas image, Palette & attached Recipes.</div>
    <div class='row' style='justify-content:flex-end'><button class='btn' id='btnDoExport'>Export</button></div>
  `, onopen:(p)=>{
    $('#btnDoExport',p).onclick=()=>{
      if(!appState.img){ alertUser("Please import an image before exporting."); return; }
      const sheet=document.createElement('canvas'); const pad=24, line=20;
      let y=pad+40, requiredHeight=y;
      appState.palette.forEach(pal=>{
        requiredHeight += line; const rec = RECIPES[pal.color];
        if(rec && rec.components) requiredHeight += rec.components.length * line;
        requiredHeight += 10;
      });
      requiredHeight = Math.max(canvas.height + (pad*2), requiredHeight);
      sheet.width=canvas.width+520; sheet.height=requiredHeight;
      const c=sheet.getContext('2d');
      c.fillStyle='#fff'; c.fillRect(0,0,sheet.width,sheet.height); c.drawImage(canvas, pad, pad);
      c.fillStyle='#000'; c.font='16px sans-serif'; c.fillText('Tattoo Lab ‚Äî Reference Sheet', canvas.width+pad*2, pad+16);
      y=pad+40;
      appState.palette.forEach(pal=>{
        const rec=(RECIPES[pal.color]);
        const colorName = pal.color.length>40 ? pal.color.slice(0,37)+'‚Ä¶' : pal.color;
        c.fillStyle='#000'; c.fillText(`${pal.brand} ‚Äî ${colorName}`, canvas.width+pad*2, y); y+=line;
        if(rec && rec.components && rec.components.length){
          rec.components.forEach(comp=>{
            const drops = comp.drops ?? comp.pct ?? '';
            const note = comp.note ? ` (${comp.note})` : '';
            c.fillStyle='#333'; c.fillText(`‚Ä¢ ${comp.ink}: ${drops}${note}`, canvas.width+pad*2+12, y); y+=line;
          });
        } else {
          c.fillStyle='#900'; c.fillText('‚Ä¢ [Recipe data missing]', canvas.width+pad*2+12, y); y+=line;
        }
        y+=10;
      });
      const a=document.createElement('a'); a.download='tattoo-reference.png'; a.href=sheet.toDataURL('image/png'); a.click();
      alertUser("Reference sheet exported as PNG.");
    };
  }}),

  palette:()=>makePanel({id:'p-palette',title:'Palette',width:330,content:`<div id='paletteHost' class='swatches'></div>`, onopen:(p)=>{
    const host=$('#paletteHost',p);
    const renderPal=()=>{
      host.innerHTML='';
      if(appState.palette.length===0){ host.innerHTML="<div class='label' style='grid-column:1/-1;text-align:center;'>No colors in palette.</div>"; return; }
      appState.palette.forEach(it=>{
        const rec=RECIPES[it.color]; if(rec){ const rgb=`rgb(${rec.rgb.join(',')})`;
          host.insertAdjacentHTML('beforeend', swatchHtml(it.color, rgb, `data-palette-item='${it.brand}:${it.color}'`, true, false));
        }
      });
    };
    renderPal();
    host.addEventListener('click',e=>{
      const btn=e.target.closest('[data-action="remove-swatch"]'); if(!btn) return;
      const sw=btn.closest('[data-palette-item]'); if(!sw) return;
      const [brand,color]=sw.getAttribute('data-palette-item').split(':');
      appState.palette = appState.palette.filter(p=>!(p.brand===brand && p.color===color));
      saveAppState(); renderPal();
      if($('#p-recipes')){ builders.recipes(); builders.recipes(); } // refresh
    });
  }}),

  brand:()=>makePanel({id:'p-brand',title:'Brand',width:330,content:`
    <div class='row'><label class='label'>Brand</label><select class='select' id='brandSelect'></select></div>
    <div class='row'><label class='label'>Ink Cap Size</label>
      <select class='select' id='inkCapSize'>
        <option value='20'>Small (~20 drops)</option>
        <option value='40'>Medium (~40 drops)</option>
        <option value='60'>Large (~60 drops)</option>
      </select>
    </div>
    <div class='swatches' id='core9Grid'></div>
  `, onopen:(p)=>{
    const sel=$('#brandSelect',p), cap=$('#inkCapSize',p), grid=$('#core9Grid',p);
    sel.innerHTML = Object.keys(brandBaseInks).map(b=>`<option value='${b}' ${b===appState.brand?'selected':''}>${b}</option>`).join('');
    cap.value=appState.inkCapSize;

    const renderCore=()=>{
      grid.innerHTML='';
      const coreInks = CORE9_MAPPING[appState.brand]||[];
      if(coreInks.length===0){ grid.innerHTML="<div class='label' style='text-align:center;grid-column:1/-1;'>Select a brand to see its core inks.</div>"; return; }
      coreInks.forEach(ink=>{
        if(!ink) return;
        const rec=RECIPES[ink.name]; if(rec){ const rgb=`rgb(${rec.rgb.join(',')})`;
          grid.insertAdjacentHTML('beforeend', swatchHtml(ink.name, rgb, `data-core9-ink='${ink.name}'`));
        }
      });
    };
    sel.onchange=()=>{ appState.brand=sel.value; saveAppState(); renderCore(); if($('#p-recipes')) builders.recipes(); };
    cap.onchange=()=>{ appState.inkCapSize=+cap.value; saveAppState(); if($('#p-recipes')) builders.recipes(); };
    grid.addEventListener('click', e=>{
      const sw=e.target.closest('[data-core9-ink]'); if(!sw) return;
      const inkName=sw.dataset.core9Ink;
      const brandName = Object.keys(brandBaseInks).find(b => inkName.startsWith(b)) || 'Generic';
      if(!appState.palette.some(p=>p.color===inkName)){ appState.palette.push({brand:brandName, color:inkName}); saveAppState(); if($('#p-palette')) builders.palette(); if($('#p-recipes')) builders.recipes(); }
    });
    renderCore();
  }}),

  recipes:()=>makePanel({id:'p-recipes',title:'Mix Recipes',width:330,content:`<div id='recipeHost' style="max-height: 400px; overflow-y: auto;"></div>`, onopen:(p)=>{
    const host=$('#recipeHost',p); host.innerHTML='';
    if(appState.palette.length===0){ host.innerHTML="<div class='label' style='text-align:center;'>Add colors to your palette to see their recipes here.</div>"; return; }
    appState.palette.forEach(it=>{
      const rec=RECIPES[it.color];
      const wrap=document.createElement('div'); wrap.className='swatch'; wrap.style.flexDirection='column'; wrap.style.alignItems='flex-start';
      const header=document.createElement('div'); header.className='row'; header.style.width='100%'; header.style.justifyContent='space-between';
      const isMaster = !!recipesFromCSV[it.color];
      const brandName = isMaster ? 'TL Color' : it.brand;
      const displayName = isMaster ? it.color.replace("TL Color ‚Äî ","") : it.color;
      const rgb=`rgb(${rec?.rgb?.join(',')||'0,0,0'})`;
      header.innerHTML = `<div style="display:flex; align-items:center; gap:8px;"><div class="dot" style="background:${rgb}"></div><span class='label' style='color:#c9d6ff; font-weight:600;'>${brandName} ‚Äî ${displayName}</span></div>`;
      wrap.appendChild(header);

      const inner=document.createElement('div'); inner.className='row'; inner.style.width='100%'; inner.style.flexWrap='wrap'; inner.style.gap='5px';

      if(rec && rec.components && rec.components.length){
        const total = rec.components.reduce((s,c)=>s+(c.drops||0),0);
        const hasNotes = rec.components.some(c=>c.note);
        if(total>0 && !hasNotes){
          const scaled = rec.components.map(c=>{
            const scaledDrops = Math.round((c.drops/total)*appState.inkCapSize);
            let name=c.ink;
            if(isMaster){
              const idx = CORE9_COLORS.findIndex(core=>core.name===c.ink.toLowerCase());
              if(idx!==-1){ const map = CORE9_MAPPING[appState.brand]; if(map && map[idx]) name=map[idx].name; }
            }
            return { ink:name, drops:scaledDrops };
          }).filter(c=>c.drops>0);
          inner.innerHTML = `<span class='label'>For ${appState.inkCapSize} drop cap:</span>` + scaled.map(c=>`<span class='chip'>${c.ink}: ${c.drops} drops</span>`).join('');
        } else {
          inner.innerHTML = `<span class='label'>Original Mix:</span>` + rec.components.map(c=>{
            let name=c.ink;
            if(isMaster){
              const idx = CORE9_COLORS.findIndex(core=>core.name===c.ink.toLowerCase());
              if(idx!==-1){ const map = CORE9_MAPPING[appState.brand]; if(map && map[idx]) name=map[idx].name; }
            }
            const drops = c.drops ?? '';
            const note = c.note ? ` (${c.note})` : '';
            return `<span class='chip'>${name}: ${drops}${note}</span>`;
          }).join('');
        }
      } else {
        inner.innerHTML = `<span class='label' style='color:#fda4af;'>Recipe data missing for this color.</span>`;
      }
      wrap.appendChild(inner); host.appendChild(wrap);
    });
  }}),

  

  grid:()=>{ const p=makePanel({id:'p-grid',title:'Grid Extract',content:`
    <div class='row'><label class='label'>Cell Size</label><input type='range' id='gridSize' class='slider' min='8' max='200' value='${appState.gridSize}'><span class='label' id='gridVal'>${appState.gridSize}px</span></div>
    <div class='row'><label class='label'>Sensitivity</label><input type='range' id='gridSensitivity' class='slider' min='1' max='30' value='${appState.gridSensitivity}'><span class='label' id='sensitivityVal'>${appState.gridSensitivity}</span></div>
    <div class='row' style='justify-content:flex-end'><button class='btn' id='btnExtract'>Extract</button></div>
    <div class='label'>Higher sensitivity means fewer, more distinct colors are added.</div>`});
    if(!p) return;
    const size=$('#gridSize',p), val=$('#gridVal',p), sens=$('#gridSensitivity',p), sensVal=$('#sensitivityVal',p), btn=$('#btnExtract',p);
    size.oninput=()=>{ appState.gridSize=+size.value; document.documentElement.style.setProperty('--grid-size', appState.gridSize+'px'); val.textContent=appState.gridSize+'px'; saveAppState(); };
    sens.oninput=()=>{ appState.gridSensitivity=+sens.value; sensVal.textContent=appState.gridSensitivity; saveAppState(); };

    btn.onclick=async ()=>{
      if(!appState.img){ alertUser("Please import an image before extracting from the grid."); return; }
      const loading=document.createElement('div'); loading.className='loading-overlay'; loading.textContent='Extracting colors...'; $('#canvas-container').appendChild(loading);
      await new Promise(r=>setTimeout(r,10));

      const integral=buildIntegral(off, ofx); const cell=appState.gridSize;
      const newEntries=[]; const newLabs=[];
      for(let y=0;y<off.height;y+=cell){
        for(let x=0;x<off.width;x+=cell){
          const x1=Math.min(x+cell, off.width), y1=Math.min(y+cell, off.height);
          const [r,g,b]=avgRegion(integral,x,y,x1,y1);
          const lab=rgbToLab(r,g,b);
          const match=nearestInk(lab);
          if(match){
            const matchBrand = Object.keys(brandBaseInks).find(b => match.name.startsWith(b)) || 'Generic';
            const already = appState.palette.some(p=>p.brand===matchBrand && p.color===match.name);
            let tooSimilar=false;
            for(const existing of newLabs){ if(deltaE2000(match.lab, existing) < appState.gridSensitivity){ tooSimilar=true; break; } }
            if(!already && !tooSimilar){ newEntries.push({brand:matchBrand,color:match.name}); newLabs.push(match.lab); }
          }
        }
      }
      appState.palette.push(...newEntries); saveAppState();
      if($('#p-palette')) builders.palette(); if($('#p-recipes')) builders.recipes();
      loading.remove(); alertUser(`Grid extraction complete. ${newEntries.length} unique colors added to palette.`);
    };
  },

  library:()=>makePanel({id:'p-library',title:'Color Library',width:330,content:`<div id='libraryHost' class="swatches color-library-grid" style="max-height: 400px; overflow-y: auto;"></div>`, onopen:(p)=>{
    const host=$('#libraryHost',p);
    const coreInkNames=(CORE9_MAPPING[appState.brand]||[]).map(ink=>ink?ink.name:null).filter(Boolean);
    const libraryInks = Object.entries(RECIPES).filter(([name,data])=>{
      const isMaster = !!recipesFromCSV[name]; const isCore = coreInkNames.includes(name); return isMaster || isCore;
    }).sort((a,b)=>a[0].localeCompare(b[0]));
    host.innerHTML = libraryInks.map(([name,data])=>{
      const rgb=`rgb(${data.rgb.join(',')})`; const isMaster=!!recipesFromCSV[name];
      const brandName = isMaster ? 'TL Color' : Object.keys(brandBaseInks).find(b=>name.startsWith(b));
      return swatchHtml(name, rgb, `data-library-ink='${name}' data-brand='${brandName}'`, false, false);
    }).join('');
    host.addEventListener('click', e=>{
      const sw=e.target.closest('[data-library-ink]'); if(!sw) return;
      const inkName=sw.dataset.libraryInk; const brandName=sw.dataset.brand;
      if(!appState.palette.some(item=>item.color===inkName)){ appState.palette.push({brand:brandName,color:inkName}); saveAppState(); if($('#p-palette')) builders.palette(); if($('#p-recipes')) builders.recipes(); }
    });
  }})
};

/* ===== Event wiring ===== */
document.addEventListener('click', (e)=>{
  const btn=e.target.closest('.tool-btn'); if(!btn) return;
  const id=btn.dataset.tool; if(!id) return;
  if(builders[id]) builders[id]();
});
document.documentElement.style.setProperty('--grid-size', appState.gridSize+'px');

/* Boot */
render();

</script>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js').then(registration => {
        console.log('ServiceWorker registration successful with scope: ', registration.scope);
      }, err => {
        console.log('ServiceWorker registration failed: ', err);
      });
    });
  }
</script>
</body>
</html>
