<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>TattooMix — Pro Theme (PWA)</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b0e13">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b0e13;
  --glass:#0f131b80;
  --panel:#0f131b;
  --panel-2:#0c0f15;
  --stroke:#1f2736;
  --stroke-2:#2a354b;
  --text:#eef2f8;
  --muted:#9fb0c9;
  --accent:#5aa8ff;
  --accent-2:#3b6bd6;
  --ok:#2ecc71;
  --warn:#ffb347;
  --shadow: 0 10px 24px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.05);
  --radius-xl: 22px;
  --radius-lg: 16px;
  --radius-md: 12px;
  --blur: 12px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background: radial-gradient(1200px 1200px at 10% -10%, #122033 0%, #0b0e13 45%) fixed;
  color:var(--text); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
}
.app{display:grid; grid-template-rows:auto 1fr; min-height:100%}
header.appbar{
  position:sticky; top:0; z-index:10;
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding:10px 14px;
  backdrop-filter: blur(var(--blur));
  background: linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.25)) ;
  border-bottom:1px solid var(--stroke);
}
.brand{
  display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.3px;
}
.brand .logo{width:34px; height:34px; border-radius:10px; background:linear-gradient(135deg,#1a2233,#0e1422); border:1px solid var(--stroke); display:grid; place-items:center; box-shadow:var(--shadow)}
.brand svg{opacity:.9}
.actions{display:flex; gap:8px; align-items:center}
.btn{
  background: linear-gradient(180deg,#182135,#0f1626);
  border:1px solid var(--stroke-2); color:var(--text);
  padding:10px 12px; border-radius:14px; box-shadow:var(--shadow); cursor:pointer;
  display:inline-flex; gap:8px; align-items:center; justify-content:center; min-width:44px;
  touch-action:manipulation;
}
.btn:active{transform:translateY(1px)}
.btn.ghost{background:linear-gradient(180deg,#101520,#0a0f1a); color:#d4e4ff}
.btn.primary{background: linear-gradient(180deg, #6cb3ff, #2a74ff); color:#0b1220; border-color:#2a74ff; text-shadow:0 1px 0 rgba(255,255,255,.4)}
.segment{
  display:flex; gap:6px; padding:6px; border-radius:999px; border:1px solid var(--stroke);
  background:linear-gradient(180deg,#0f141f,#0a0f19); box-shadow:var(--shadow)
}
.segment .seg{
  padding:8px 14px; border-radius:999px; color:var(--muted); cursor:pointer; border:1px solid transparent;
}
.segment .seg.active{ background:linear-gradient(180deg,#1a2235,#0e1522); color:var(--text); border-color:var(--stroke-2); box-shadow:var(--shadow) }

main{
  display:grid; grid-template-columns: minmax(280px, 58%) minmax(320px, 1fr);
  gap:16px; padding:16px; align-items:start;
}
.card{
  background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
  border:1px solid var(--stroke); border-radius:var(--radius-xl); box-shadow:var(--shadow);
  overflow:hidden;
}
.card > header{
  padding:12px 16px; border-bottom:1px solid var(--stroke); display:flex; align-items:center; justify-content:space-between;
}
.card .body{ padding:14px 16px }
.hint{ color:var(--muted); font-size:12px }
.row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
select,input,textarea{
  background:linear-gradient(180deg,#0b111a,#070c14);
  border:1px solid var(--stroke-2); color:var(--text);
  border-radius:12px; padding:10px 12px; min-height:42px;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
}
label.small{font-size:12px; color:var(--muted); margin-right:6px}

#canvasWrap{
  height:54vh; border:1px solid var(--stroke); border-radius:18px;
  background: radial-gradient(600px 400px at 30% 20%, #0f1b2a 0%, #0b1019 55%);
  display:flex; align-items:center; justify-content:center; overflow:hidden;
}
canvas{ max-width:100%; max-height:100%; display:block }
#paletteStrip{ display:flex; gap:12px; flex-wrap:wrap; margin-top:10px }
.swatch{
  width:46px; height:46px; border-radius:12px; border:1px solid var(--stroke);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.06), 0 4px 14px rgba(0,0,0,.5); position:relative;
}
.swatch::after{ content:attr(data-hex); position:absolute; bottom:-18px; left:50%; transform:translateX(-50%); font-size:10px; color:var(--muted) }

.metaGrid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:8px }

/* Recipes */
#recipes{ max-height:calc(100vh - 220px); overflow:auto; padding:6px }
.recipe{
  background:linear-gradient(180deg,#0c121d,#0a1019);
  border:1px solid var(--stroke); border-radius:18px; padding:12px;
  display:grid; grid-template-columns:56px 1fr; gap:12px; align-items:center; margin-bottom:10px;
}
.sw{ width:56px; height:56px; border-radius:12px; border:1px solid var(--stroke) }
.heading{ font-weight:700; letter-spacing:.2px }
.muted{ color:var(--muted); font-size:12px }
.inkrow{ display:flex; flex-wrap:wrap; gap:8px; margin-top:4px }
.chip{
  display:inline-flex; gap:6px; align-items:center; border-radius:999px; padding:6px 10px;
  background:linear-gradient(180deg,#0e1522,#0a0f1a); border:1px solid var(--stroke-2); color:#cfe1ff; box-shadow:var(--shadow);
}

/* Sticky footer toolbar on iPad */
.toolbar{
  position:sticky; bottom:0; z-index:5; margin-top:8px;
  display:flex; justify-content:space-between; align-items:center; gap:10px;
  padding:8px 12px; border-top:1px solid var(--stroke);
  background:linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,.45));
  backdrop-filter: blur(8px);
}
.status{ color:#b8c9e6; font-size:12px; }
.badge{ padding:6px 10px; border:1px solid var(--stroke); border-radius:999px; background:#0e1522; color:#9fc6ff }

/* Focus rings */
:where(button, .btn, select, input):focus{ outline:2px solid #2a74ff55; outline-offset:2px }
</style>
</head>
<body>
<div class="app">
  <header class="appbar">
    <div class="brand">
      <div class="logo">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
          <circle cx="12" cy="12" r="9" stroke="#5aa8ff" stroke-width="2"/>
          <path d="M7 12h10M12 7v10" stroke="#5aa8ff" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <div>TattooMix</div>
      <div class="badge">PWA</div>
    </div>
    <div class="actions">
      <div class="segment" role="tablist" aria-label="Mode">
        <button class="seg active" id="segBasic">Basic</button>
        <button class="seg" id="segAdvanced">Advanced</button>
      </div>
      <button class="btn ghost" id="btnSave" title="Save Project">Save</button>
      <button class="btn ghost" id="btnLoad" title="Load Project">Load</button>
      <input type="file" id="loadInput" accept=".tatmix,application/json" style="display:none"/>
      <button class="btn primary" id="btnExportPNG">Export PNG</button>
      <button class="btn ghost" id="btnExportPDF">Print / PDF</button>
    </div>
  </header>

  <main>
    <!-- LEFT -->
    <section class="card">
      <header>
        <div>
          <div class="heading">Reference & Palette</div>
          <div class="hint">Import image → Auto-extract or long‑press to sample specific areas</div>
        </div>
        <div class="row">
          <button class="btn" id="btnImport">Import Image</button>
          <button class="btn" id="btnExtract">Auto‑extract</button>
          <label class="small">K</label>
          <select id="kColors"><option>5</option><option selected>6</option><option>7</option><option>8</option></select>
          <input type="file" id="fileInput" accept="image/*" style="display:none" />
        </div>
      </header>
      <div class="body">
        <div class="metaGrid">
          <div><label class="small">Studio / Artist</label><input id="studioInput" placeholder="Studio Name or Artist"/></div>
          <div><label class="small">Client</label><input id="clientInput" placeholder="Client name"/></div>
          <div><label class="small">Date</label><input id="dateInput" type="date"/></div>
          <div><label class="small">Placement</label><input id="placementInput" placeholder="Forearm, Upper back…"/></div>
        </div>
        <div id="canvasWrap"><canvas id="canvas" width="0" height="0"></canvas></div>
        <div class="row" style="margin-top:10px">
          <label class="small">Brand</label>
          <select id="brandSel"></select>
          <label class="small">Cap size</label>
          <select id="capSel">
            <option value="S">Small (20 drops)</option>
            <option value="M" selected>Medium (40 drops)</option>
            <option value="L">Large (80 drops)</option>
          </select>
          <span class="badge" id="statusChip">Ready</span>
        </div>
        <div id="paletteStrip"></div>

        <div class="toolbar">
          <div class="status">Tip: Basic shows **drops**. Switch to Advanced for %, ml, oz & “My Inks”.</div>
          <div class="row">
            <label class="small">Units</label>
            <select id="unitSel">
              <option value="drops" selected>Drops</option>
              <option value="percent">%</option>
              <option value="ml">ml</option>
              <option value="oz">oz</option>
            </select>
            <label class="small" id="lblBatch" style="display:none">Batch caps</label>
            <input type="number" id="batchCaps" min="1" value="1" step="1" style="width:100px; display:none"/>
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="card">
      <header>
        <div class="heading">Mix Recipes</div>
        <div class="hint" id="modeHint">Basic: drops only</div>
      </header>
      <div class="body">
        <div id="recipes"></div>
        <div id="advancedOnly" style="display:none; margin-top:8px">
          <div class="heading" style="margin-bottom:6px">My Inks</div>
          <div id="myInksList"></div>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
// Register service worker for offline use
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('service-worker.js').catch(console.error);
  });
}
</script>

<script>
// --- Brand palettes and app logic (trimmed comments; same logic as theme build) ---
const BRANDS = {
  "Radiant": [
    {name:"Radiant White", hex:"#FFFFFF"},
    {name:"Real Black", hex:"#111111"},
    {name:"Blood Red", hex:"#C21807"},
    {name:"Blue", hex:"#1E50A2"},
    {name:"Canary Yellow", hex:"#FFD12A"},
    {name:"Medium Green", hex:"#2FA84F"},
    {name:"Tiger Orange", hex:"#FF7A00"},
    {name:"Chocolate", hex:"#6B3E26"},
    {name:"Fuchsia", hex:"#C218C2"},
    {name:"Lavender", hex:"#B57EDC"},
  ],
  "Eternal": [
    {name:"Lining Black", hex:"#111111"},
    {name:"White", hex:"#FFFFFF"},
    {name:"Bright Orange", hex:"#FF7F2A"},
    {name:"True Blue", hex:"#0076CE"},
    {name:"Light Purple", hex:"#B27AD3"},
    {name:"Lime Green", hex:"#7FD321"},
    {name:"Dark Brown", hex:"#4D2C1E"},
    {name:"Light Magenta", hex:"#FF6FB5"},
    {name:"Lipstick Red", hex:"#C21E3A"},
    {name:"Caramel", hex:"#A86D3D"},
  ],
  "Solid": [
    {name:"El Picante", hex:"#CF4F2E"},
    {name:"Satan Red", hex:"#B0122E"},
    {name:"Traditional Orange", hex:"#FF6A1C"},
    {name:"Oro", hex:"#E6B422"},
    {name:"Dirty Green", hex:"#6B8F3B"},
    {name:"Jade", hex:"#00A86B"},
    {name:"Green 7", hex:"#008B45"},
    {name:"Blue 15", hex:"#1E50A2"},
    {name:"Old Brown", hex:"#5C3B2E"},
    {name:"Coffee", hex:"#4B3621"},
  ],
  "Raw": [
    {name:"Raw White", hex:"#FFFFFF"},
    {name:"Pitch Black", hex:"#111111"},
    {name:"Bright Yellow", hex:"#FFD11A"},
    {name:"Blue Sky", hex:"#2CA9E1"},
    {name:"Raw Green", hex:"#2E8B57"},
    {name:"Laker Purple", hex:"#7F3FBF"},
    {name:"Light Red", hex:"#E24C4B"},
    {name:"Agent Orange", hex:"#FF6A00"},
    {name:"Bloodberry", hex:"#B03060"},
    {name:"Yellow Ochre", hex:"#C99700"},
  ]
};

const state = {
  mode: "basic",
  brand: "Radiant",
  cap: "M",
  unit: "drops",
  batchCaps: 1,
  swatches: ['#F56A6A','#52A7FF','#73D98E','#B093F1'],
  myInks: new Set(),
  _imgBitmap: null
};

const $ = (id)=> document.getElementById(id);
const segBasic = $('segBasic'), segAdvanced = $('segAdvanced');
const btnImport = $('btnImport'), fileInput = $('fileInput');
const btnExtract = $('btnExtract'), kSel = $('kColors');
const btnSave = $('btnSave'), btnLoad = $('btnLoad'), loadInput = $('loadInput');
const btnExportPNG = $('btnExportPNG'), btnExportPDF = $('btnExportPDF');
const canvas = $('canvas'); const ctx = canvas.getContext('2d', { willReadFrequently: true });
const paletteStrip = $('paletteStrip'); const recipes = $('recipes');
const brandSel = $('brandSel'); const capSel = $('capSel'); const unitSel = $('unitSel');
const batchCaps = $('batchCaps'); const modeHint = $('modeHint');
const advancedOnly = $('advancedOnly'); const myInksList = $('myInksList');
const studioInput = $('studioInput'); const clientInput = $('clientInput'); const dateInput = $('dateInput'); const placementInput = $('placementInput');
const statusChip = $('statusChip');
dateInput.valueAsDate = new Date();

Object.keys(BRANDS).forEach(b=>{ const o=document.createElement('option'); o.value=b; o.textContent=b; brandSel.appendChild(o) });
brandSel.value = state.brand; capSel.value = state.cap; unitSel.value = state.unit;

segBasic.onclick = ()=> setMode('basic'); segAdvanced.onclick = ()=> setMode('advanced');
function setMode(m){
  state.mode = m;
  segBasic.classList.toggle('active', m==='basic');
  segAdvanced.classList.toggle('active', m==='advanced');
  advancedOnly.style.display = (m==='advanced') ? 'block' : 'none';
  document.getElementById('lblBatch').style.display = (m==='advanced') ? 'inline-block' : 'none';
  batchCaps.style.display = (m==='advanced') ? 'inline-block' : 'none';
  modeHint.textContent = (m==='basic') ? 'Basic: drops only' : 'Advanced: drops, %, ml, oz & My Inks';
  if(m==='basic') unitSel.value='drops';
  renderRecipes();
}

// Image import
btnImport.onclick = ()=> fileInput.click();
fileInput.onchange = async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const img = await createImageBitmap(f);
  state._imgBitmap = img; fitAndDraw(img);
};
function fitAndDraw(img){
  const maxW = 1600, maxH = 900;
  let w=img.width, h=img.height;
  const sc = Math.min(1, maxW/w, maxH/h);
  w=Math.round(w*sc); h=Math.round(h*sc);
  canvas.width=w; canvas.height=h;
  ctx.clearRect(0,0,w,h); ctx.drawImage(img,0,0,w,h);
}
btnExtract.onclick = ()=>{
  if(canvas.width===0){ flash('Load an image first'); return; }
  const k = parseInt(kSel.value,10);
  const colors = extractPalette(canvas,k);
  state.swatches = colors.map(rgbToHex);
  renderPalette(); computeAllRecipes();
};

// Long-press sample
let pressTimer=null;
canvas.addEventListener('mousedown',(e)=>{ pressTimer=setTimeout(()=> sampleAt(e),450)});
['mouseup','mouseleave'].forEach(ev=> canvas.addEventListener(ev,()=> clearTimeout(pressTimer)));
canvas.addEventListener('touchstart',(e)=>{ const t=e.touches[0]; pressTimer=setTimeout(()=> sampleAt(t),500)});
canvas.addEventListener('touchend',()=> clearTimeout(pressTimer));
function sampleAt(e){
  const rect = canvas.getBoundingClientRect();
  const x = Math.floor((e.clientX-rect.left) * (canvas.width/rect.width));
  const y = Math.floor((e.clientY-rect.top) * (canvas.height/rect.height));
  const data = ctx.getImageData(Math.max(0,x-2), Math.max(0,y-2), 5,5).data;
  let R=0,G=0,B=0,N=0; for(let i=0;i<data.length;i+=4){ R+=data[i]; G+=data[i+1]; B+=data[i+2]; N++;}
  const hx = rgbToHex([Math.round(R/N), Math.round(G/N), Math.round(B/N)]);
  state.swatches.push(hx); renderPalette(); computeAllRecipes();
}

// Palette render
function renderPalette(){
  paletteStrip.innerHTML='';
  state.swatches.forEach(hx=>{
    const d=document.createElement('div'); d.className='swatch'; d.style.background=hx; d.dataset.hex=hx; paletteStrip.appendChild(d);
  });
}

// Controls
brandSel.onchange = ()=>{ state.brand=brandSel.value; refreshMyInks(); computeAllRecipes(); }
capSel.onchange   = ()=>{ state.cap=capSel.value; computeAllRecipes(); }
unitSel.onchange  = ()=>{ state.unit=unitSel.value; renderRecipes(); }
batchCaps.oninput = ()=>{ state.batchCaps=Math.max(1, parseInt(batchCaps.value||'1',10)); computeAllRecipes(); }

function refreshMyInks(){
  myInksList.innerHTML='';
  const inks = BRANDS[state.brand];
  if(state.myInks.size===0) inks.forEach(i=> state.myInks.add(i.name));
  inks.forEach(ink=>{
    const row=document.createElement('div'); row.className='row'; row.style.marginBottom='4px';
    const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=state.myInks.has(ink.name);
    cb.onchange=()=>{ if(cb.checked) state.myInks.add(ink.name); else state.myInks.delete(ink.name); computeAllRecipes(); }
    const label=document.createElement('label'); label.textContent=ink.name; label.className='small';
    row.appendChild(cb); row.appendChild(label); myInksList.appendChild(row);
  });
}
refreshMyInks();

function hexToRgb(hx){ hx=hx.replace('#',''); return [parseInt(hx.slice(0,2),16),parseInt(hx.slice(2,4),16),parseInt(hx.slice(4,6),16)]; }
function rgbToHex([r,g,b]){ return '#'+[r,g,b].map(v=>Math.max(0,Math.min(255,v)).toString(16).padStart(2,'0')).join('').toUpperCase(); }
function srgbToLinear(c){ c/=255; return c<=0.04045? c/12.92 : Math.pow((c+0.055)/1.055,2.4); }
function rgbToXyz([r,g,b]){
  const R=srgbToLinear(r), G=srgbToLinear(g), B=srgbToLinear(b);
  const X = R*0.4124564 + G*0.3575761 + B*0.1804375;
  const Y = R*0.2126729 + G*0.7151522 + B*0.0721750;
  const Z = R*0.0193339 + G*0.1191920 + B*0.9503041;
  return [X,Y,Z];
}
function xyzToLab([X,Y,Z]){
  const Xr=0.95047, Yr=1.00000, Zr=1.08883;
  function f(t){ return t>0.008856? Math.cbrt(t) : (7.787*t + 16/116); }
  const fx=f(X/Xr), fy=f(Y/Yr), fz=f(Z/Zr);
  const L = 116*fy - 16;
  const a = 500*(fx - fy);
  const b = 200*(fy - fz);
  return [L,a,b];
}
function rgbToLab(rgb){ return xyzToLab(rgbToXyz(rgb)); }
function distLab(a,b){ const dL=a[0]-b[0], da=a[1]-b[1], db=a[2]-b[2]; return Math.sqrt(dL*dL+da*da+db*db); }

function extractPalette(cv, k){
  const w=cv.width, h=cv.height; const data=ctx.getImageData(0,0,w,h).data;
  const step=Math.max(1, Math.floor((w*h)/5000)); const pts=[];
  for(let i=0;i<data.length;i+=4*step){ pts.push([data[i],data[i+1],data[i+2]]) }
  const centers=[]; for(let i=0;i<k;i++) centers.push(pts[Math.floor(Math.random()*pts.length)]);
  const labCenters=centers.map(rgbToLab);
  let changed=true, it=0;
  while(changed && it<12){
    it++; changed=false;
    const bucket=Array.from({length:k},()=>({sum:[0,0,0], n:0}));
    for(const p of pts){
      const lp=rgbToLab(p); let best=0,bd=1e9;
      for(let j=0;j<k;j++){ const d=distLab(lp, labCenters[j]); if(d<bd){bd=d; best=j} }
      const b=bucket[best]; b.sum[0]+=p[0]; b.sum[1]+=p[1]; b.sum[2]+=p[2]; b.n++;
    }
    for(let j=0;j<k;j++){
      if(bucket[j].n>0){
        const newc=[bucket[j].sum[0]/bucket[j].n,bucket[j].sum[1]/bucket[j].n,bucket[j].sum[2]/bucket[j].n];
        const newLab=rgbToLab(newc); if(distLab(newLab, labCenters[j])>1){ changed=true; labCenters[j]=newLab; centers[j]=newc; }
      }
    }
  }
  centers.sort((a,b)=> rgbToLab(b)[0] - rgbToLab(a)[0]);
  return centers.map(c=> [Math.round(c[0]),Math.round(c[1]),Math.round(c[2])]);
}

function solveWeights(targetRgb, subset){
  const A=subset.map(ink=> hexToRgb(ink.hex)).map(v=> v.map(s=>{s/=255; return s<=0.04045? s/12.92 : Math.pow((s+0.055)/1.055,2.4)}));
  const c=targetRgb.map(s=>{s/=255; return s<=0.04045? s/12.92 : Math.pow((s+0.055)/1.055,2.4)});
  const n=A.length; let w=Array(n).fill(1/n);
  function mulAw(w){ const y=[0,0,0]; for(let j=0;j<n;j++){ y[0]+=A[j][0]*w[j]; y[1]+=A[j][1]*w[j]; y[2]+=A[j][2]*w[j]; } return y; }
  function grad(w){ const y=mulAw(w); const r=[y[0]-c[0],y[1]-c[1],y[2]-c[2]]; const g=Array(n).fill(0);
    for(let j=0;j<n;j++){ g[j]=2*(A[j][0]*r[0]+A[j][1]*r[1]+A[j][2]*r[2]); } return g; }
  function projectSimplex(v){
    const u=[...v].sort((a,b)=>b-a); let css=0,rho=0; for(let i=0;i<v.length;i++){ css+=u[i]; if(u[i]+(1-css)/(i+1)>0) rho=i; }
    const theta=(1 - u.slice(0,rho+1).reduce((s,x)=>s+x,0))/(rho+1); return v.map(x=> Math.max(0, x+theta));
  }
  let t=0.1; for(let it=0; it<400; it++){ const g=grad(w); w=w.map((wi,i)=> wi - t*g[i]); w=projectSimplex(w); t*=0.98; } return w;
}

function pickSubset(targetHex, brandInks){
  const targetLab=rgbToLab(hexToRgb(targetHex));
  const arr=brandInks.map(ink=>({ink, d:distLab(targetLab, rgbToLab(hexToRgb(ink.hex)))})); arr.sort((a,b)=>a.d-b.d);
  const chosen=arr.slice(0,3).map(x=>x.ink);
  const L=targetLab[0]; const add=[];
  const hasWhite=brandInks.find(i=> i.name.toLowerCase().includes('white'));
  const hasBlack=brandInks.find(i=> i.name.toLowerCase().includes('black'));
  if(L>70 && hasWhite) add.push(hasWhite); if(L<30 && hasBlack) add.push(hasBlack);
  const all=[...chosen]; add.forEach(ink=>{ if(!all.find(x=>x.name===ink.name)) all.push(ink)});
  return all.slice(0,4);
}

function computeAllRecipes(){
  const inksBase=BRANDS[state.brand];
  const inks= state.mode==='advanced' ? inksBase.filter(i=> state.myInks.has(i.name)) : inksBase;
  const capDrops={S:20,M:40,L:80}[state.cap] * state.batchCaps;
  const results= state.swatches.map(hx=>{
    const subset=pickSubset(hx, inks);
    const w=solveWeights(hexToRgb(hx), subset);
    const comp=subset.map((ink,i)=>({ink, w:w[i]})).filter(x=>x.w>0.02).sort((a,b)=>b.w-a.w).slice(0,4);
    const sum=comp.reduce((s,c)=> s+c.w,0) || 1; comp.forEach(c=> c.w/=sum);
    const raw=comp.map(c=> c.w*capDrops); const drops=raw.map(x=> Math.max(0, Math.round(x)));
    let diff=capDrops - drops.reduce((s,x)=>s+x,0);
    while(diff!==0){ const idx=drops.indexOf(Math.max(...drops)); drops[idx] += (diff>0?1:-1); diff=capDrops - drops.reduce((s,x)=>s+x,0); }
    comp.forEach((c,i)=> c.drops=drops[i]);
    return {hex:hx, comp};
  });
  state._results=results; renderRecipes();
}

function renderRecipes(){
  recipes.innerHTML='';
  const unit= state.mode==='basic' ? 'drops' : unitSel.value;
  const capDrops={S:20,M:40,L:80}[state.cap] * state.batchCaps;
  state._results?.forEach(res=>{
    const card=document.createElement('div'); card.className='recipe';
    const sw=document.createElement('div'); sw.className='sw'; sw.style.background=res.hex;
    const body=document.createElement('div');
    const hdr=document.createElement('div'); hdr.className='heading'; hdr.textContent=res.hex;
    const meta=document.createElement('div'); meta.className='muted'; meta.textContent=`Brand ${state.brand} • Cap ${state.cap} • total ${capDrops} drops`;
    const list=document.createElement('div'); list.className='inkrow';
    const unitEff=(state.mode==='basic' ? 'drops' : unitSel.value);
    res.comp.forEach(c=>{
      const chip=document.createElement('div'); chip.className='chip';
      let value=''; if(unitEff==='drops'){ value=`${c.drops} drops` }
      else if(unitEff==='percent'){ value=`${Math.round(c.w*100)}%` }
      else if(unitEff==='ml'){ value=`${(c.drops*0.05).toFixed(2)} ml` }
      else if(unitEff==='oz'){ value=`${(c.drops*0.05/29.5735).toFixed(3)} oz` }
      chip.textContent=`${c.ink.name} — ${value}`; list.appendChild(chip);
    });
    body.appendChild(hdr); body.appendChild(meta); body.appendChild(list);
    card.appendChild(sw); card.appendChild(body); recipes.appendChild(card);
  });
}

// Save/Load
btnSave.onclick=()=>{
  if(canvas.width===0){ flash('Import an image first'); return; }
  const dataUrl=canvas.toDataURL('image/png');
  const payload={ v:1, studio:studioInput.value||'', client:clientInput.value||'', date:dateInput.value||'', placement:placementInput.value||'',
    brand:state.brand, cap:state.cap, unit: state.mode==='basic' ? 'drops' : unitSel.value, batchCaps:state.batchCaps,
    swatches:state.swatches, results:(state._results||[]).map(r=>({hex:r.hex, comp:r.comp.map(c=>({name:c.ink.name, drops:c.drops, w:c.w}))})), image:dataUrl };
  const blob=new Blob([JSON.stringify(payload)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`${(clientInput.value||'tattoo').replace(/\s+/g,'_')}_${(dateInput.value||'today')}.tatmix`; a.click();
  flash('Project saved');
};
btnLoad.onclick=()=> loadInput.click();
loadInput.onchange= async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const text=await f.text(); try{ const p=JSON.parse(text); applyProject(p); flash('Project loaded'); }catch(err){ console.error(err); flash('Invalid project'); }
};
function applyProject(p){
  studioInput.value=p.studio||''; clientInput.value=p.client||''; if(p.date) dateInput.value=p.date; placementInput.value=p.placement||'';
  state.brand=p.brand||'Radiant'; brandSel.value=state.brand; state.cap=p.cap||'M'; capSel.value=state.cap;
  state.batchCaps=p.batchCaps||1; batchCaps.value=p.batchCaps||1;
  state.swatches=p.swatches||[]; renderPalette();
  if(p.image){ const im=new Image(); im.onload=()=>{ const off=document.createElement('canvas'); off.width=im.width; off.height=im.height; off.getContext('2d').drawImage(im,0,0);
      createImageBitmap(off).then(bm=>{ state._imgBitmap=bm; fitAndDraw(bm); }); }; im.src=p.image; }
  computeAllRecipes();
}

// Export PNG / PDF
btnExportPNG.onclick = ()=> exportSheet('png');
btnExportPDF.onclick = ()=> exportSheet('pdf');
function exportSheet(kind){
  if(!state._results || state._results.length===0){ flash('Nothing to export'); return; }
  const out=document.createElement('canvas'); drawExportSheet(out);
  setTimeout(()=>{
    const url=out.toDataURL('image/png');
    if(kind==='png'){
      const a=document.createElement('a'); a.href=url; a.download='TattooMix_ReferenceSheet.png'; a.click();
    }else{
      const w=window.open('','_blank'); w.document.write('<html><head><title>TattooMix PDF</title><style>body{margin:0}</style></head><body>');
      w.document.write('<img src="'+url+'" style="width:100%;max-width:100%;">'); w.document.write('</body></html>'); w.document.close(); w.focus(); w.print();
    }
  }, 300);
}
function drawExportSheet(cvs){
  const W=2200, H=240 + 900 + 60 +  (state._results.length*140) + 120;
  cvs.width=W; cvs.height=H; const g=cvs.getContext('2d');
  g.fillStyle='#0b0f15'; g.fillRect(0,0,W,H);
  g.fillStyle='#e8edf3'; g.font='bold 46px Inter, system-ui'; g.fillText(studioInput.value || 'TattooMix Reference & Mix Sheet', 40, 80);
  g.font='22px Inter, system-ui'; g.fillStyle='#9aa4b4';
  g.fillText(`Client: ${clientInput.value||'-'}    Date: ${dateInput.value||'-'}    Placement: ${placementInput.value||'-'}`, 40, 116);
  g.fillText(`Brand: ${state.brand}   •   Cap: ${state.cap} (${({S:20,M:40,L:80}[state.cap])} drops)   •   Mode: ${state.mode}`, 40, 146);
  const imgDataUrl=canvas.toDataURL('image/png'); const img=new Image();
  img.onload=()=>{
    const boxX=40, boxY=180, boxW=1040, boxH=900; g.strokeStyle='#2a3450'; g.lineWidth=4; g.strokeRect(boxX,boxY,boxW,boxH);
    const iw=img.width, ih=img.height; const sc=Math.min(boxW/iw, boxH/ih); const dw=Math.round(iw*sc), dh=Math.round(ih*sc);
    g.drawImage(img, boxX+Math.floor((boxW-dw)/2), boxY+Math.floor((boxH-dh)/2), dw, dh);
    g.fillStyle='#e8edf3'; g.font='bold 30px Inter'; g.fillText('Palette', 1120, 200);
    const r=28, gap=22; let sx=1120, sy=240, col=0;
    state.swatches.forEach(hx=>{ g.fillStyle=hx; g.beginPath(); g.arc(sx+r, sy+r, r, 0, Math.PI*2); g.fill();
      g.lineWidth=3; g.strokeStyle='#2a3450'; g.stroke();
      g.fillStyle='#9aa4b4'; g.font='18px Inter'; g.fillText(hx, sx, sy+r*2+24);
      col++; sx+= r*2 + gap; if(col%6===0){ sx=1120; sy += r*2 + 44; }
    });
    let y= sy + r*2 + 60; g.fillStyle='#e8edf3'; g.font='bold 30px Inter'; g.fillText('Mix Recipes', 1120, y); y+= 46;
    const unitEff=(state.mode==='basic' ? 'drops' : unitSel.value); const capDrops=({S:20,M:40,L:80}[state.cap]) * state.batchCaps;
    state._results.forEach(res=>{
      g.fillStyle='#10141c'; g.strokeStyle='#2a3450'; g.lineWidth=3; g.fillRect(1100,y-10,1040,110); g.strokeRect(1100,y-10,1040,110);
      g.fillStyle=res.hex; g.fillRect(1120,y,80,80);
      g.fillStyle='#e8edf3'; g.font='bold 22px Inter'; g.fillText(res.hex, 1220, y+24);
      g.fillStyle='#9aa4b4'; g.font='18px Inter'; g.fillText(`Total: ${capDrops} drops`, 1220, y+48);
      g.font='18px Inter'; g.fillStyle='#cfe1ff'; let cy=y+74;
      res.comp.forEach(c=>{
        let value=''; if(unitEff==='drops'){ value=`${c.drops} drops` }
        else if(unitEff==='percent'){ value=`${Math.round(c.w*100)}%` }
        else if(unitEff==='ml'){ value=`${(c.drops*0.05).toFixed(2)} ml` }
        else if(unitEff==='oz'){ value=`${(c.drops*0.05/29.5735).toFixed(3)} oz` }
        g.fillText(`${c.ink.name} — ${value}`, 1220, cy); cy+=20;
      });
      y+=130;
    });
  };
  img.src=imgDataUrl;
}

function flash(msg){ statusChip.textContent=msg; setTimeout(()=>{ statusChip.textContent='Ready' }, 1100); }
state._results=[]; renderPalette(); computeAllRecipes(); setMode('basic');
</script>
</body>
</html>
