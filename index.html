<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Tattoo Lab — PWA (v5c)</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b0e13">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<link rel="icon" type="image/png" href="icons/icon-64.png">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="app.css">
</head>
<body>
<div class="app">
  <div class="appbar">
    <div class="brand"><img src="icons/icon-64.png" alt=""><span>Tattoo Lab</span> <span class="badge" id="tierBadge">Basic</span> <span class="badge">PWA</span></div>
    <div class="segment" role="tablist" aria-label="Mode">
      <button class="seg active" id="segBasic">Basic</button>
      <button class="seg" id="segPro">Pro</button>
    </div>
    <div class="row">
      <button class="btn" id="themeToggle">Toggle Theme</button>
      <button class="btn locked" id="btnSave">Save</button>
      <button class="btn locked" id="btnLoad">Load</button>
      <input type="file" id="loadInput" accept=".tatmix,application/json" style="display:none" />
      <button class="btn primary locked" id="btnExportPNG">Export PNG</button>
      <button class="btn locked" id="btnExportPDF">Print / PDF</button>
    </div>
  </div>

  <main>
    <section class="card">
      <header>
        <div>
          <div style="font-weight:700">Reference & Palette</div>
          <div class="hint" id="hdrHint">Tap with the Eyedropper to add colors (Auto-extract is Pro)</div>
        </div>
        <div class="row">
          <button class="btn" id="btnImport">Import Image</button>
          <button class="btn locked" id="btnExtract">Auto-extract</button>
          <label class="hint">K</label>
          <select id="kColors" disabled><option>5</option><option selected>6</option><option>7</option><option>8</option></select>
          <label class="hint"><input type="checkbox" id="biasPure" checked> Prefer pure colors</label>
          <label class="hint">Precision</label>
          <select id="sampleSize">
            <option value="1">1 px</option>
            <option value="3">3×3</option>
            <option value="5" selected>5×5</option>
            <option value="9">9×9</option>
          </select>
          <label class="hint">Markers</label>
          <select id="markerSel"><option value="on" selected>On</option><option value="off">Off</option></select>
          <input type="file" id="fileInput" accept="image/*" style="display:none" />
        </div>
      </header>
      <div class="body">
        <div class="row" style="margin-bottom:8px">
          <label class="hint">Brand</label>
          <select id="brandSel"></select>
          <label class="hint">Cap</label>
          <select id="capSel"><option value="S">Small (20)</option><option value="M" selected>Medium (40)</option><option value="L">Large (80)</option></select>
          <label class="hint">Units</label>
          <select id="unitSel" disabled><option value="drops" selected>Drops</option><option value="percent">%</option><option value="ml">ml</option><option value="oz">oz</option></select>
          <span class="badge" id="statusChip">Ready</span>
        </div>

        <div class="metaGrid" id="metaGrid" style="display:none;grid-template-columns:repeat(2,minmax(120px,1fr));gap:10px;margin:8px 0 4px 0">
          <div><label class="hint">Studio / Artist</label><input id="studioInput" placeholder="Studio / Artist"/></div>
          <div><label class="hint">Client</label><input id="clientInput" placeholder="Client"/></div>
          <div><label class="hint">Date</label><input id="dateInput" type="date"/></div>
          <div><label class="hint">Placement</label><input id="placementInput" placeholder="Forearm, Upper back…"/></div>
        </div>

        <div class="toolrow" style="margin:8px 0">
          <button class="btn" id="btnEyedropper">Eyedropper</button>
          <button class="btn" id="btnUndo">Undo swatch</button>
          <span class="hint">Tap on the image to add that color to the palette. A loupe appears under your finger for precision.</span>
        </div>

        <div id="canvasWrap" data-sampling="off">
          <div id="loupe"><canvas id="loupeCanvas" width="90" height="90"></canvas></div>
          <canvas id="canvas" width="0" height="0"></canvas>
        </div>
        <div id="paletteStrip"></div>

        <div class="toolbar">
          <div class="hint" id="tip">Basic trial: manual Eyedropper + drops only. Pro unlocks auto-extract, save/export, %, ml, oz, session fields, and Pro palette styles.</div>
          <div class="row" id="proOnlyControls" style="display:flex">
            <button class="btn" id="btnStyleSquare">3D Squares</button>
            <button class="btn" id="btnStyleSplatPng">Ink Splats (PNG)</button>
            <button class="btn" id="btnStyleSplatSvg">Ink Splats (SVG)</button>
            <button class="btn" id="btnUpgrade">Upgrade to Pro</button>
            <label class="hint" style="margin-left:6px"><input id="exportMarkers" type="checkbox" checked style="margin-right:6px" />Include markers on export</label>
            <button class="btn" id="btnSplatConfig">Splat Path</button>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <header>
        <div style="font-weight:700">Mix Recipes</div>
        <div class="hint" id="modeHint">Drops only (Basic)</div>
      </header>
      <div class="body">
        <div id="recipes"></div>
      </div>
    </section>
  </main>
</div>

<!-- Splat SVG modal -->
<div id="splatModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);align-items:center;justify-content:center;z-index:30">
  <div class="dialog">
    <h3 style="margin:0 0 8px 0">Custom Splat SVG Path (Pro)</h3>
    <p class="hint" style="margin:0 0 8px 0">Paste an SVG <code>path d=""</code> string. Swatches update live. Saved locally.</p>
    <textarea id="splatInput" placeholder="M50,10 C... Z"></textarea>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="splatSave">Save</button>
      <button class="btn" id="splatClear">Clear</button>
      <button class="btn primary" id="splatClose">Close</button>
    </div>
  </div>
</div>

<!-- Upgrade modal -->
<div id="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);align-items:center;justify-content:center;z-index:20">
  <div class="dialog">
    <h3 style="margin:0 0 8px 0">Tattoo Lab Pro</h3>
    <p class="hint" style="margin:0 0 12px 0">Auto-extract palettes, save/load sessions, export printable mix sheets, 3D splat palettes, and more.</p>
    <div class="row">
      <button class="btn primary" id="closeModal">OK</button>
    </div>
  </div>
</div>

<script>
if('serviceWorker' in navigator){ window.addEventListener('load', ()=>{ navigator.serviceWorker.register('service-worker.js'); }); }
const root = document.documentElement;
const savedTheme = localStorage.getItem('tl-theme'); if(savedTheme === 'light'){ root.classList.add('light'); }
document.getElementById('themeToggle').onclick = ()=>{ root.classList.toggle('light'); localStorage.setItem('tl-theme', root.classList.contains('light') ? 'light' : 'dark'); };
</script>
<script src="app.js"></script>
</body>
</html>
